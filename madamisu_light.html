<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>クリムゾン・マンション殺人事件（オフライン簡易版）</title>
  <style>
    :root{
      --red:#8B0000; /* ダークレッド */
      --gold:#FFD700; /* ゴールド */
      --bg:#2C2C2C;   /* ダークグレー */
      --text:#FFFFFF; /* ホワイト */
      --muted:#999;
      --card:#3a3a3a;
      --accent:#b22222;
      --ok:#1e8e3e;
    }
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #1e1e1e, var(--bg)); color:var(--text);
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 16px; background:var(--red); border-bottom:1px solid #000;
      position:sticky; top:0; z-index:3;
    }
    header h1{ font-size:16px; margin:0; letter-spacing:.02em }
    header .phase{ font-weight:700; }
    main{ max-width:980px; margin:24px auto; padding:0 16px; }
    .card{ background:var(--card); border:1px solid #000; border-radius:12px; padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,.35) }
    .row{ display:grid; gap:16px }
    .row.cols-2{ grid-template-columns: 1fr 1fr }
    .row.cols-3{ grid-template-columns: repeat(3, 1fr) }
    @media (max-width: 800px){ .row.cols-2, .row.cols-3{ grid-template-columns: 1fr } }
    .btn{
      appearance:none; border:0; padding:12px 16px; border-radius:10px; cursor:pointer; font-weight:700; color:#fff; background:var(--accent);
      transition: transform .05s ease, filter .15s ease, opacity .2s ease; box-shadow: 0 6px 18px rgba(0,0,0,.35);
    }
    .btn.secondary{ background:#444 }
    .btn.ghost{ background:transparent; border:1px solid #555 }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .btn:hover{ filter:brightness(1.08) }
    .btn:active{ transform: translateY(1px) }
    .bar{ height:10px; background:#444; border-radius:8px; overflow:hidden }
    .fill{ height:100%; background:linear-gradient(90deg, var(--gold), #ff9f1a) }
    .muted{ color:var(--muted) }
    .list{ margin:8px 0 0 0; padding:0 0 0 18px }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; background:#4a4a4a; font-size:12px; margin-right:6px }
    .grid{ display:grid; grid-template-columns: 1fr 2fr; gap:20px }
    @media (max-width: 860px){ .grid{ grid-template-columns: 1fr } }
    .char{ border-left:4px solid var(--gold); padding-left:12px }
    .char h3{ margin:.2rem 0 .5rem }
    .evidence{ border-left:4px solid var(--red); padding-left:12px }

    /* プライバシー画面（受け渡し時の隠す幕） */
    .veil{ position:fixed; inset:0; background:#111; display:none; align-items:center; justify-content:center; z-index:9999 }
    .veil.active{ display:flex }
    .veil .panel{ background:#181818; border:1px solid #000; border-radius:16px; padding:24px; max-width:520px; text-align:center }

    /* 投票ボタン群 */
    .vote-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:12px }
    .vote-btn{ background:#4b1b1b; border:1px solid #5d2222; padding:14px; border-radius:12px; cursor:pointer; text-align:left }
    .vote-btn:hover{ filter:brightness(1.1) }
    .vote-btn small{ display:block; color:#ccc }

    .result-row{ display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px; background:#393939; margin-bottom:8px }
    .result-row.winner{ outline:2px solid var(--gold) }

    .footer-note{ font-size:12px; color:#bbb; margin-top:8px }

    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#000; color:#fff; padding:2px 6px; border-radius:6px; border:1px solid #444 }
  </style>
</head>
<body>
  <header>
    <h1>クリムゾン・マンション殺人事件（オフライン簡易版）</h1>
    <div class="phase" id="phaseLabel">準備</div>
  </header>
  <main>
    <div id="screen"></div>
  </main>

  <!-- 受け渡し用ヴェール -->
  <div class="veil" id="veil">
    <div class="panel">
      <h2>画面を隠して端末を渡してください</h2>
      <p class="muted">次のプレイヤーが準備できたら、下のボタンを押してください。</p>
      <button class="btn" id="veilContinue">準備OK</button>
    </div>
  </div>

  <script>
    // -------------------------------
    // データ定義（必要に応じて編集）
    // -------------------------------
    const SCENARIO = {
      title: "クリムゾン・マンション殺人事件",
      setting: {
        era: "現代",
        place: "山奥の豪華別荘『クリムゾン・マンション』",
        status: "嵐により外部と遮断された別荘で殺人事件が発生",
      },
      victim: {
        name: "富豪の父親（別荘の主人）",
        cause: "毒殺",
        spot: "書斎",
        time: "夜10時頃",
        weapon: "毒入りのブランデー",
      },
      culpritCharacterKey: "chef", // 真犯人のキャラキー（勝敗判定に使用）
      evidences: [
        { id: 1, title: "毒入りブランデーグラス", desc: "被害者の机上で発見。被害者の指紋のみ。" },
        { id: 2, title: "破れた遺言書の断片", desc: "暖炉付近で見つかる。遺言内容は不明。" },
        { id: 3, title: "薬品の空き瓶", desc: "倉庫で発見。強い苦味のある薬品の痕跡。" },
      ],
      characters: [
        { key:"heir",   name:"富豪の息子", role:"大学生", 
          secret:"最近、遺産の前借りを父に断られた。夜10時前、書斎の前を通った。",
          hint:"被害者は晩酌のブランデーにこだわっていた。鍵は常に持ち歩いている。" },
        { key:"secretary", name:"秘書", role:"被害者の右腕", 
          secret:"とある取引で被害者の機密に関与。遺言書の案に異議を唱えていた。",
          hint:"書斎の金庫は暗証番号式。番号は被害者の誕生日と関連がある。" },
        { key:"chef",   name:"料理人", role:"ベテラン", 
          secret:"家族の医療費がかさみ借金がある。倉庫の棚の整理をしていた。",
          hint:"倉庫には苦味の強い薬品が置いてある。ブランデーの香りは強い。" },
        { key:"doctor", name:"医師", role:"家族の友人", 
          secret:"個人的な投資で大損し借金。処方薬に苦味成分の強いものがある。",
          hint:"薬品は少量でも強い苦味を残す。砂糖で誤魔化すのは難しい。" },
        { key:"lawyer", name:"弁護士", role:"遺言関与", 
          secret:"遺言書作成に関与。最新案のコピーを持っていたが紛失。",
          hint:"最新案では相続配分が大きく変更されていた形跡がある。" },
        { key:"gardener", name:"庭師", role:"長年仕える", 
          secret:"被害者に理不尽に叱責された過去。夜は温室にいたと主張。",
          hint:"温室から書斎へは屋外を通れば短時間で行き来が可能。" },
      ],
      truth: {
        summary: "犯人は料理人。倉庫の苦味の強い薬品をブランデーに混入し、香りで誤魔化した。遺言書争いに見せかけた偽装があった。",
        motive: "家族の医療費のための金銭的逼迫。被害者に援助を断られ追い詰められていた。",
        method: "倉庫で薬品をグラスに微量混入。強い香りのブランデーで苦味を覆い、書斎に置かれたグラスで被害者が飲むよう誘導。",
      }
    };

    // -------------------------------
    // 状態
    // -------------------------------
    const state = {
      phase: "setup", // setup -> handout -> overview -> debate -> vote -> result
      playerCount: 0,
      players: [], // { id:1..n, name:"プレイヤー1", charKey: "heir" }
      assignIdx: 0, // ハンドアウト表示順制御
      voteIdx: 0,   // 投票順制御
      votes: [],    // { voterId, targetCharKey }
    };

    const $ = (sel) => document.querySelector(sel);
    const screen = $("#screen");
    const phaseLabel = $("#phaseLabel");

    // フェーズ表示
    function setPhaseLabel(text){ phaseLabel.textContent = text }

    // 乱数ユーティリティ
    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i], a[j]] = [a[j], a[i]] }
      return a;
    }

    // 初期画面（人数選択）
    function renderSetup(){
      state.phase = "setup"; setPhaseLabel("準備");
      screen.innerHTML = `
        <div class="card">
          <h2 style="margin-top:4px">ゲーム開始</h2>
          <p class="muted">この簡易版は<b>1台の端末</b>を交互に見せ合って進行します。サーバ通信は一切行いません。</p>
          <div class="row cols-2" style="margin-top:14px">
            <div class="card" style="background:#333">
              <h3>プレイ人数を選択</h3>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 14px">
                ${[4,5,6].map(n=>`<button class="btn" data-n="${n}">${n} 人</button>`).join("")}
              </div>
              <div id="names"></div>
            </div>
            <div class="card" style="background:#333">
              <h3>シナリオ概要</h3>
              <p class="muted">${SCENARIO.setting.era}／${SCENARIO.setting.place}<br>${SCENARIO.setting.status}</p>
              <ul class="list">
                <li>被害者：${SCENARIO.victim.name}</li>
                <li>死因：${SCENARIO.victim.cause}</li>
                <li>発見場所：${SCENARIO.victim.spot}／発見時刻：${SCENARIO.victim.time}</li>
                <li>凶器：${SCENARIO.victim.weapon}</li>
              </ul>
              <p class="footer-note">※ 個人目標や密談は省略。全体議論のみのライト版です。</p>
            </div>
          </div>
        </div>`;

      // ボタンにリスナー
      screen.querySelectorAll("button[data-n]").forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const n = parseInt(btn.dataset.n,10);
          state.playerCount = n;
          // プレイヤー名入力（任意）
          const box = $("#names");
          box.innerHTML = `<div style="margin-top:6px">
            <label class="muted">プレイヤー名（空欄可。未入力は自動でP1..になります）</label>
            <div class="row cols-2" style="margin-top:8px">${Array.from({length:n}).map((_,i)=>`
              <input placeholder="プレイヤー${i+1}" data-name-idx="${i}" style="padding:10px;border-radius:10px;border:1px solid #555;background:#222;color:#fff">`).join('')}</div>
            <div style="display:flex; gap:10px; margin-top:16px">
              <button class="btn" id="startAssign">キャラクターを配役して開始</button>
              <button class="btn secondary" id="randNames">名前を自動入力</button>
            </div>
          </div>`;

          $("#randNames").onclick = () => {
            screen.querySelectorAll('[data-name-idx]').forEach((inp,i)=> inp.value = `プレイヤー${i+1}`);
          };

          $("#startAssign").onclick = () => {
            const names = Array.from(screen.querySelectorAll('[data-name-idx]')).map((inp,i)=> inp.value.trim() || `プレイヤー${i+1}`);
            // キャラクターを人数分抽出してシャッフル
            const chars = shuffle(SCENARIO.characters).slice(0, n);
            state.players = names.map((name, i)=> ({ id:i+1, name, charKey: chars[i].key }));
            state.assignIdx = 0; state.votes = []; state.voteIdx = 0;
            openVeil(() => renderHandout());
          };
        });
      });
    }

    // ヴェール（受け渡し）
    function openVeil(next){
      const v = $("#veil"); v.classList.add('active');
      $("#veilContinue").onclick = ()=>{ v.classList.remove('active'); next && next(); };
    }

    // ハンドアウト表示（1人ずつ）
    function renderHandout(){
      state.phase = "handout"; setPhaseLabel("ハンドアウト配布");
      const i = state.assignIdx; const player = state.players[i];
      const char = SCENARIO.characters.find(c=>c.key===player.charKey);
      screen.innerHTML = `
        <div class="card">
          <div class="pill">${i+1} / ${state.playerCount}</div>
          <h2>${player.name} のハンドアウト</h2>
          <div class="grid" style="margin-top:12px">
            <div class="char">
              <h3>${char.name}（${char.role}）</h3>
              <p><b>あなたの秘密</b><br>${char.secret}</p>
              <p class="muted">ヒント：${char.hint}</p>
            </div>
            <div class="evidence">
              <h3>事件概要（共通）</h3>
              <ul class="list">
                <li>被害者：${SCENARIO.victim.name}</li>
                <li>死因：${SCENARIO.victim.cause}</li>
                <li>発見場所：${SCENARIO.victim.spot}（${SCENARIO.victim.time}）</li>
                <li>凶器：${SCENARIO.victim.weapon}</li>
              </ul>
              <h4 style="margin-top:10px">初期証拠品</h4>
              <ul class="list">${SCENARIO.evidences.map(e=>`<li><b>${e.title}</b>：${e.desc}</li>`).join('')}</ul>
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:flex-end">
            ${i < state.playerCount-1
              ? '<button class="btn" id="nextHandout">次の人へ</button>'
              : '<button class="btn" id="toOverview">全体共有へ</button>'}
          </div>
          <p class="footer-note">※ 受け渡し時は画面を隠してください（<span class="kbd">準備OK</span>）</p>
        </div>`;

      const next = (i < state.playerCount-1)
        ? () => { state.assignIdx++; renderHandout(); }
        : renderOverview;

      const btnId = (i < state.playerCount-1) ? "#nextHandout" : "#toOverview";
      $(btnId).onclick = () => openVeil(next);
    }

    // 共通情報（全体共有）
    function renderOverview(){
      state.phase = "overview"; setPhaseLabel("情報共有");
      const assignedChars = state.players.map(p => SCENARIO.characters.find(c=>c.key===p.charKey));
      screen.innerHTML = `
        <div class="card">
          <h2>全体共有</h2>
          <div class="row cols-2" style="margin-top:8px">
            <div class="card" style="background:#333">
              <h3>登場キャラクター（今回の配役）</h3>
              <ul class="list">${assignedChars.map(c=>`<li>${c.name}（${c.role}）</li>`).join('')}</ul>
            </div>
            <div class="card" style="background:#333">
              <h3>証拠品</h3>
              <ul class="list">${SCENARIO.evidences.map(e=>`<li><b>${e.title}</b>：${e.desc}</li>`).join('')}</ul>
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:space-between; align-items:center">
            <span class="muted">口頭でアリバイ・知っている情報を共有してください。</span>
            <button class="btn" id="toDebate">議論開始</button>
          </div>
        </div>`;
      $("#toDebate").onclick = renderDebate;
    }

    // 議論（単に遷移だけ、タイマー等なし）
    function renderDebate(){
      state.phase = "debate"; setPhaseLabel("議論");
      screen.innerHTML = `
        <div class="card">
          <h2>議論フェーズ</h2>
          <p class="muted">この簡易版ではチャットやメモ機能はありません。口頭で議論してください。</p>
          <div class="row cols-2" style="margin-top:12px">
            <div class="card" style="background:#333">
              <h3>配役</h3>
              <ul class="list">${state.players.map(p=>{
                const c = SCENARIO.characters.find(cc=>cc.key===p.charKey);
                return `<li>${p.name}：${c.name}</li>`
              }).join('')}</ul>
            </div>
            <div class="card" style="background:#333">
              <h3>証拠品早見</h3>
              <ul class="list">${SCENARIO.evidences.map(e=>`<li><b>${e.title}</b>：${e.desc}</li>`).join('')}</ul>
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:flex-end">
            <button class="btn" id="toVote">投票へ</button>
          </div>
        </div>`;
      $("#toVote").onclick = () => { state.voteIdx = 0; state.votes = []; openVeil(renderVote); };
    }

    // 投票（1人ずつ、自分は選べない）
    function renderVote(){
      state.phase = "vote"; setPhaseLabel("投票");
      const i = state.voteIdx; const voter = state.players[i];
      const assignedChars = state.players.map(p => SCENARIO.characters.find(c=>c.key===p.charKey));
      screen.innerHTML = `
        <div class="card">
          <div class="pill">${i+1} / ${state.playerCount}</div>
          <h2>${voter.name} の投票</h2>
          <p>犯人だと思うキャラクターを選んでください。（自分以外）</p>
          <div class="vote-grid" id="voteGrid">
            ${state.players.map(p=>{
              const c = assignedChars.find(ac=>ac.key===p.charKey);
              const disabled = (p.id === voter.id) ? 'data-disabled="1"' : '';
              return `<button class="vote-btn" data-target="${c.key}" ${disabled}>
                <strong>${c.name}</strong>
                <small>${p.name} の役</small>
              </button>`
            }).join('')}
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:flex-end">
            <button class="btn" id="confirmVote" disabled>投票する</button>
          </div>
          <p class="footer-note">※ 受け渡し時は画面を隠してください（<span class="kbd">準備OK</span>）</p>
        </div>`;

      let selected = null;
      screen.querySelectorAll('.vote-btn').forEach(btn=>{
        const isDisabled = btn.dataset.disabled === '1';
        if(isDisabled){ btn.style.opacity = .5; btn.style.pointerEvents = 'none'; }
        btn.addEventListener('click', ()=>{
          if(isDisabled) return;
          screen.querySelectorAll('.vote-btn').forEach(b=> b.style.outline = 'none');
          btn.style.outline = '2px solid var(--gold)';
          selected = btn.dataset.target;
          $("#confirmVote").disabled = false;
        });
      });

      $("#confirmVote").onclick = () => {
        if(!selected) return;
        state.votes.push({ voterId: voter.id, targetCharKey: selected });
        if(i < state.playerCount - 1){
          state.voteIdx++; openVeil(renderVote);
        } else {
          renderResult();
        }
      };
    }

    // 結果表示・勝敗判定
    function renderResult(){
      state.phase = "result"; setPhaseLabel("結果");
      // 集計
      const countMap = {}; const keyToDisp = {};
      state.players.forEach(p => {
        const c = SCENARIO.characters.find(x=>x.key===p.charKey);
        keyToDisp[c.key] = { char: c, player: p };
      });
      for(const v of state.votes){ countMap[v.targetCharKey] = (countMap[v.targetCharKey]||0) + 1 }
      // 表示用並べ替え（票数降順）
      const rows = Object.keys(keyToDisp).map(k=>({
        key:k, disp:keyToDisp[k], votes: countMap[k]||0
      })).sort((a,b)=> b.votes - a.votes);

      const topVotes = rows[0]?.votes || 0;
      const tops = rows.filter(r=> r.votes===topVotes);
      const mostKey = (tops.length===1) ? tops[0].key : null; // 同票なら犯人不在として扱う

      // 勝敗
      const culpritKey = SCENARIO.culpritCharacterKey;
      const citizensWin = (mostKey && mostKey === culpritKey);

      screen.innerHTML = `
        <div class="card">
          <h2>投票結果</h2>
          <div style="margin:12px 0">
            ${rows.map(r=>{
              const cls = (r.key===mostKey) ? 'result-row winner' : 'result-row';
              return `<div class="${cls}">
                <div style="min-width:150px"><b>${r.disp.char.name}</b><br><span class="muted">(${r.disp.player.name})</span></div>
                <div class="bar" style="flex:1"><div class="fill" style="width:${(r.votes/state.playerCount)*100}%"></div></div>
                <div style="min-width:60px; text-align:right"><b>${r.votes}</b> 票</div>
              </div>`
            }).join('')}
          </div>

          <div class="card" style="background:#333; margin-top:14px">
            <h3>勝敗</h3>
            ${mostKey ? `
              <p>最多票：<b>${keyToDisp[mostKey].char.name}</b></p>
              <p>${citizensWin ? '市民チームの勝利！真犯人を特定しました。' : '犯人の勝利！投票で逃げ切りました。'}</p>
            ` : `
              <p>同票により犯人不在。<b>犯人の勝利！</b></p>
            `}
          </div>

          <div class="card" style="background:#333; margin-top:14px">
            <h3>真相</h3>
            <p><b>真犯人：</b>${SCENARIO.characters.find(c=>c.key===culpritKey).name}</p>
            <p><b>動機：</b>${SCENARIO.truth.motive}</p>
            <p><b>犯行方法：</b>${SCENARIO.truth.method}</p>
            <p class="muted">要約：${SCENARIO.truth.summary}</p>
          </div>

          <div style="display:flex; gap:10px; margin-top:16px; justify-content:space-between; align-items:center">
            <span class="muted">もう一度遊ぶには、最初からやり直してください。</span>
            <div>
              <button class="btn secondary" id="seeOverview">共通情報へ戻る</button>
              <button class="btn" id="restart">最初に戻る</button>
            </div>
          </div>
        </div>`;

      $("#restart").onclick = renderSetup;
      $("#seeOverview").onclick = renderOverview;
    }

    // 初期化
    renderSetup();
  </script>
</body>
</html>
