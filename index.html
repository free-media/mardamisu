<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>マーダーミステリー（オフライン簡易版）</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
    }
    .font-noto {
        font-family: 'Noto Sans JP', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-noto">
  <!-- Header -->
  <header class="bg-red-900/80 backdrop-blur-sm sticky top-0 z-10 border-b border-black/50">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <h1 id="title" class="text-lg font-bold text-yellow-300 tracking-wider">シナリオ未選択</h1>
            <div id="phaseLabel" class="text-sm font-semibold bg-white/20 text-white py-1 px-3 rounded-full">シナリオ選択</div>
        </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
    <div id="screen"></div>
  </main>

  <!-- Veil for player transition -->
  <div id="veil" class="fixed inset-0 bg-black/90 flex-col items-center justify-center z-50 hidden">
    <div class="bg-gray-800 border border-yellow-400/30 rounded-2xl p-8 max-w-md text-center shadow-2xl shadow-yellow-400/10">
      <h2 class="text-2xl font-bold text-yellow-300 mb-4">画面を隠してください</h2>
      <p class="text-gray-400 mb-6">次のプレイヤーの準備ができたら、下のボタンを押して端末を渡してください。</p>
      <button id="veilContinue" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-300 focus:ring-opacity-50">準備OK</button>
    </div>
  </div>

  <script>
    // ==============================
    // Game Elements
    // ==============================
    const titleEl = document.getElementById('title');
    const phaseLabel = document.getElementById('phaseLabel');
    const screen = document.getElementById('screen');
    const veil = document.getElementById('veil');
    const veilContinueBtn = document.getElementById('veilContinue');
    const $ = (sel) => document.querySelector(sel);

    let SCENARIO = null; // To be assigned after selection

    // ==============================
    // Scenario Data
    // ==============================
    const SCENARIOS = {
      honnoji: {
        title: '本能寺の変 - 信長を殺したのは誰か',
        image: 'http://googleusercontent.com/file_content/1', // 画像URLを追加
        setting: { era:'安土桃山時代', place:'京都・本能寺', status:'天下統一を目前にした織田信長が家臣に裏切られ襲撃された。' },
        victim: { name:'織田信長', cause:'不明（焼死体のため特定不能）', spot:'本能寺・本殿', time:'天正10年6月2日未明' },
        culpritCharacterKey: 'mitsuhide',
        evidences:[
          {id:1, title:'愛宕百韻（あたごひゃくいん）', desc:'事件直前に光秀が催した連歌会。謀反の決意を詠んだと解釈できる句「時は今 あめが下しる 五月かな」がある。'},
          {id:2, title:'堺の商人からの書状', desc:'家康宛ての書状。「信長様の身辺に危険が迫っている」と、事件を予見したかのような内容が記されている。'},
          {id:3, title:'備中高松城からの密使の報告', desc:'秀吉の陣からの報告。「光秀謀反」の報せを受けた後の秀吉の行動が、あまりに迅速で用意周到であったと記されている。'},
        ],
        characters:[
          { key:'mitsuhide', name:'明智光秀', role:'織田家重臣', secret:'信長から過酷な叱責や理不尽な領地替えの命令を受け、強い恨みを抱いていた。', hint:'備中高松城への出陣命令に背き、突如として軍を京都へ向けた。その決断の理由は？' },
          { key:'hideyoshi', name:'羽柴（豊臣）秀吉', role:'織田家重臣', secret:'事件をまるで予見していたかのように、驚異的な速さで京へ引き返す「中国大返し」の準備を事前に整えていた。', hint:'事件の第一報を聞いた後の行動が迅速すぎる。本当に事件を知らなかったのか？' },
          { key:'ieyasu', name:'徳川家康', role:'同盟者', secret:'信長の招待で堺に滞在中だったが、事件直後に伊賀越えという極めて危険なルートで領国へ逃れた。なぜ最短経路を知っていたのか。', hint:'堺の有力商人との繋がりが深く、独自の諜報網を持っていたとされる。' },
        ],
        truth:{
          summary:'犯人は明智光秀。信長への積年の恨みから謀反を決意し、本能寺を襲撃したとされるのが通説。',
          motive:'信長からのパワハラや、四国征伐を巡る対立による個人的な恨み、天下への野心など、諸説ある。',
          method:'中国攻めの援軍と偽り1万3千の兵を率いて京に入り、油断していた信長が滞在する本能寺を急襲・放火した。',
        }
      },
      rikyu: {
        title: '千利休の切腹 - 利休を追い込んだ黒幕',
        image: 'https://placehold.co/600x400/2E8B57/FFFFFF?text=%E5%8D%83%E5%88%A9%E4%BC%91', // Placeholder image
        setting: { era:'安土桃山時代', place:'京都・聚楽第', status:'茶の湯を大成させた千利休が、天下人・秀吉の怒りを買い切腹を命じられた。' },
        victim: { name:'千利休', cause:'切腹', spot:'自邸', time:'天正19年2月28日' },
        culpritCharacterKey: 'hideyoshi',
        evidences:[
          {id:1, title:'大徳寺山門の木像', desc:'利休が自身の木像を山門に設置。これを見た秀吉が「利休が自分を見下している」と激怒したとされる。'},
          {id:2, title:'茶器の売買記録', desc:'利休が斡旋した茶器が、法外な値段で取引されていたとされる帳簿。三成がこれを発見し、秀吉に報告したという。'},
          {id:3, title:'前田利家からの手紙', desc:'利休の助命を嘆願する内容だが、「関白殿下（秀吉）の怒り尋常ならず」と書かれており、説得が不可能だったことを示唆している。'},
        ],
        characters:[
          { key:'hideyoshi', name:'豊臣秀吉', role:'天下人（関白）', secret:'利休の影響力が茶の湯の世界に留まらず、政治的にも大きくなりすぎた。自身の権威を脅かす存在だと感じ、疎ましく思っている。', hint:'黄金を好み、派手な権威を示す自分に対し、わびさびを重んじる利休の価値観が気に食わない。' },
          { key:'mitsunari', name:'石田三成', role:'秀吉の側近（五奉行）', secret:'利休の政治的な影響力を快く思っておらず、秀吉の側近としての自分の地位を脅かす存在だと考えている。利休の失脚を狙っていた。', hint:'利休が茶器を不当に高値で売買しているという噂を、秀吉の耳に入れたのは自分だ。' },
          { key:'ieyasu', name:'徳川家康', role:'大名（五大老）', secret:'利休とは親交があったが、秀吉との決定的な対立を避けるため、表立って助けようとはしなかった。しかし裏では利休の弟子たちを保護している。', hint:'利休の死後、彼の「わび茶」の精神は家康の治世で再評価されることになる。今は耐える時だ。' },
        ],
        truth:{
          summary:'黒幕は豊臣秀吉。自身の権威を脅かす存在となった利休を、様々な理由をこじつけて排除した。',
          motive:'権力闘争。利休の審美眼や価値観が、秀吉の黄金の茶室に代表される価値観と対立し、その政治的な影響力も無視できなくなったため。',
          method:'大徳寺山門の木像事件や茶器売買疑惑などを口実に、絶対的な権力で切腹を命じた。三成の讒言もその一助となった。',
        }
      },
    };

    // ==============================
    // Game State
    // ==============================
    const state = {
      phase: 'pick',
      playerCount: 0,
      players: [], // {id, name, charKey}
      assignIdx: 0,
      voteIdx: 0,
      votes: [],
    };

    // ==============================
    // Utility Functions
    // ==============================
    function setPhaseLabel(text) {
      phaseLabel.textContent = text;
    }

    function openVeil(next) {
      veil.classList.remove('hidden');
      veil.classList.add('flex');
      veilContinueBtn.onclick = () => {
        veil.classList.add('hidden');
        veil.classList.remove('flex');
        next && next();
      };
    }

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    
    // ==============================
    // Render Functions
    // ==============================

    // Screen: Scenario Picker
    function renderScenarioPicker() {
      state.phase = 'pick';
      setPhaseLabel('シナリオ選択');
      titleEl.textContent = 'シナリオ未選択';
      screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700">
          <h2 class="text-2xl font-bold text-yellow-300 mb-4">シナリオを選択</h2>
          <p class="text-gray-400 mb-6">プレイしたい歴史シナリオを選んでください。（3人プレイ専用です）</p>
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Honnoji Card -->
            <div class="bg-gray-900/70 rounded-xl border border-red-800/50 hover:border-red-600 transition-all duration-300 flex flex-col overflow-hidden">
              <img src="${SCENARIOS.honnoji.image}" alt="本能寺の変" class="w-full h-40 object-cover">
              <div class="p-6 flex flex-col flex-grow">
                <h3 class="text-xl font-bold text-red-400">本能寺の変</h3>
                <p class="text-gray-400 mt-2 mb-4 flex-grow">王道のテーマ。織田信長は誰に殺されたか。</p>
                <button class="w-full mt-auto bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105" id="pickHonnoji">このシナリオを読み込む</button>
              </div>
            </div>
            <!-- Rikyu Card -->
            <div class="bg-gray-900/70 rounded-xl border border-green-800/50 hover:border-green-600 transition-all duration-300 flex flex-col overflow-hidden">
              <img src="${SCENARIOS.rikyu.image}" alt="千利休" class="w-full h-40 object-cover">
              <div class="p-6 flex flex-col flex-grow">
                <h3 class="text-xl font-bold text-green-400">千利休の切腹</h3>
                <p class="text-gray-400 mt-2 mb-4 flex-grow">天下人の逆鱗に触れた真の理由とは。</p>
                <button class="w-full mt-auto bg-green-800 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105" id="pickRikyu">このシナリオを読み込む</button>
              </div>
            </div>
          </div>
        </div>`;

      $('#pickHonnoji').onclick = () => {
        SCENARIO = SCENARIOS.honnoji;
        afterScenarioLoaded();
      };
      $('#pickRikyu').onclick = () => {
        SCENARIO = SCENARIOS.rikyu;
        afterScenarioLoaded();
      };
    }

    function afterScenarioLoaded() {
      titleEl.textContent = SCENARIO.title;
      renderSetup();
    }

    // Screen: Setup
    function renderSetup() {
      if (!SCENARIO) return renderScenarioPicker();
      state.phase = 'setup';
      setPhaseLabel('準備');
      const characterCount = SCENARIO.characters.length;

      screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700">
          <h2 class="text-2xl font-bold text-yellow-300 mb-2">ゲーム開始</h2>
          <p class="text-gray-400 mb-6">この簡易版は<b>1台の端末</b>を交代で操作して進行します。</p>
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Player Setup -->
            <div class="bg-gray-900/70 p-6 rounded-xl border border-gray-700">
              <h3 class="text-lg font-bold text-white">プレイ人数</h3>
              <p class="text-gray-300 mb-4">このシナリオは <b>${characterCount}人</b> でプレイします。</p>
              <div id="names"></div>
            </div>
            <!-- Scenario Overview -->
            <div class="bg-gray-900/70 p-6 rounded-xl border border-gray-700">
              <h3 class="text-lg font-bold text-white">シナリオ概要</h3>
              <p class="text-gray-400 text-sm mt-2">${SCENARIO.setting.era}／${SCENARIO.setting.place}</p>
              <p class="text-gray-300 mt-1">${SCENARIO.setting.status}</p>
              <ul class="list-disc list-inside text-gray-300 mt-4 space-y-1">
                <li><b>被害者：</b>${SCENARIO.victim.name}</li>
                <li><b>死因：</b>${SCENARIO.victim.cause}</li>
                <li><b>場所/日時：</b>${SCENARIO.victim.spot} / ${SCENARIO.victim.time}</li>
              </ul>
            </div>
          </div>
        </div>`;
      
      state.playerCount = characterCount;
      const namesBox = $('#names');
      namesBox.innerHTML = `
        <label class="text-sm text-gray-400 block mb-2">プレイヤー名（空欄可）</label>
        <div class="space-y-3 mb-4">
          ${Array.from({length: characterCount}).map((_, i) => `
            <input placeholder="プレイヤー${i + 1}" data-name-idx="${i}" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
          `).join('')}
        </div>
        <div class="flex flex-col sm:flex-row gap-3 mt-4">
          <button class="w-full bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-2 px-4 rounded-lg transition" id="startAssign">配役して開始</button>
          <button class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition" id="changeScenario">シナリオ変更</button>
        </div>`;

      $('#changeScenario').onclick = () => renderScenarioPicker();
      $('#startAssign').onclick = () => {
        const names = Array.from(screen.querySelectorAll('[data-name-idx]')).map((inp, i) => inp.value.trim() || `プレイヤー${i + 1}`);
        const chars = shuffle(SCENARIO.characters);
        state.players = names.map((name, i) => ({ id: i + 1, name, charKey: chars[i].key }));
        state.assignIdx = 0;
        state.votes = [];
        state.voteIdx = 0;
        openVeil(() => renderHandout());
      };
    }

    // Screen: Handout
    function renderHandout() {
      state.phase = 'handout';
      setPhaseLabel('ハンドアウト配布');
      const i = state.assignIdx;
      const player = state.players[i];
      const char = SCENARIO.characters.find(c => c.key === player.charKey);

      screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700 relative">
          <div class="absolute top-4 right-4 bg-yellow-500 text-gray-900 text-xs font-bold px-3 py-1 rounded-full">${i + 1} / ${state.playerCount}</div>
          <h2 class="text-2xl font-bold text-yellow-300 mb-4">${player.name} のハンドアウト</h2>
          <div class="grid md:grid-cols-5 gap-6">
            <!-- Character Info -->
            <div class="md:col-span-2 bg-gray-900/70 p-5 rounded-xl border border-yellow-400/30">
              <h3 class="text-xl font-bold text-yellow-300">あなたは【${char.name}】です</h3>
              <p class="text-gray-400 mt-1"><b>役割：</b>${char.role}</p>
              <p class="mt-4 text-gray-300"><b>あなたの秘密：</b><br>${char.secret}</p>
              <p class="mt-4 text-sm text-yellow-400/80 bg-yellow-900/30 p-3 rounded-md"><b>ヒント：</b>${char.hint}</p>
            </div>
            <!-- Case Info -->
            <div class="md:col-span-3 bg-gray-900/70 p-5 rounded-xl border border-red-800/50">
              <h3 class="text-xl font-bold text-red-400">事件概要（共通）</h3>
              <ul class="list-disc list-inside text-gray-300 mt-3 space-y-1">
                <li><b>被害者：</b>${SCENARIO.victim.name}</li>
                <li><b>死因：</b>${SCENARIO.victim.cause}</li>
                <li><b>場所/日時：</b>${SCENARIO.victim.spot}（${SCENARIO.victim.time}）</li>
              </ul>
              <h4 class="text-lg font-bold text-red-400 mt-5">初期証拠品</h4>
              <ul class="list-disc list-inside text-gray-300 mt-3 space-y-2">${SCENARIO.evidences.map(e => `<li><b>${e.title}</b>：${e.desc}</li>`).join('')}</ul>
            </div>
          </div>
          <div class="flex justify-end mt-6">
            ${i < state.playerCount - 1 ? '<button class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-lg transition" id="nextHandout">次の人へ</button>' : '<button class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg transition" id="toOverview">全体共有へ</button>'}
          </div>
        </div>`;

      const nextAction = (i < state.playerCount - 1) ? () => { state.assignIdx++; renderHandout(); } : renderOverview;
      const btnId = (i < state.playerCount - 1) ? '#nextHandout' : '#toOverview';
      $(btnId).onclick = () => openVeil(nextAction);
    }

    // Screen: Overview
    function renderOverview() {
      state.phase = 'overview';
      setPhaseLabel('情報共有');
      const assignedChars = state.players.map(p => SCENARIO.characters.find(c => c.key === p.charKey));
      screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700">
          <h2 class="text-2xl font-bold text-yellow-300 mb-4">全体共有</h2>
          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-gray-900/70 p-5 rounded-xl border border-gray-700">
              <h3 class="text-lg font-bold text-white">登場人物（今回の配役）</h3>
              <ul class="list-disc list-inside text-gray-300 mt-3 space-y-1">${assignedChars.map(c => `<li>${c.name}（${c.role}）</li>`).join('')}</ul>
            </div>
            <div class="bg-gray-900/70 p-5 rounded-xl border border-gray-700">
              <h3 class="text-lg font-bold text-white">証拠品</h3>
              <ul class="list-disc list-inside text-gray-300 mt-3 space-y-2">${SCENARIO.evidences.map(e => `<li><b>${e.title}</b>：${e.desc}</li>`).join('')}</ul>
            </div>
          </div>
          <div class="flex justify-between items-center mt-6">
            <span class="text-gray-400">口頭でアリバイや情報を共有してください。</span>
            <button class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg transition" id="toDebate">議論開始</button>
          </div>
        </div>`;
      $('#toDebate').onclick = renderDebate;
    }

    // Screen: Debate
    function renderDebate() {
        state.phase = 'debate';
        setPhaseLabel('議論');
        screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700">
            <h2 class="text-2xl font-bold text-yellow-300 mb-4">議論フェーズ</h2>
            <p class="text-gray-400 mb-6">口頭で自由に議論し、犯人を見つけ出してください。</p>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-gray-900/70 p-5 rounded-xl border border-gray-700">
                    <h3 class="text-lg font-bold text-white">配役</h3>
                    <ul class="list-disc list-inside text-gray-300 mt-3 space-y-1">${state.players.map(p => { const c = SCENARIO.characters.find(cc => cc.key === p.charKey); return `<li>${p.name}：<b>${c.name}</b></li>` }).join('')}</ul>
                </div>
                <div class="bg-gray-900/70 p-5 rounded-xl border border-gray-700">
                    <h3 class="text-lg font-bold text-white">証拠品早見</h3>
                    <ul class="list-disc list-inside text-gray-300 mt-3 space-y-2">${SCENARIO.evidences.map(e => `<li><b>${e.title}</b></li>`).join('')}</ul>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button class="bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition" id="toVote">投票へ</button>
            </div>
        </div>`;
        $('#toVote').onclick = () => {
            state.voteIdx = 0;
            state.votes = [];
            openVeil(renderVote);
        };
    }

    // Screen: Vote
    function renderVote() {
      state.phase = 'vote';
      setPhaseLabel('投票');
      const i = state.voteIdx;
      const voter = state.players[i];
      
      screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700 relative">
          <div class="absolute top-4 right-4 bg-yellow-500 text-gray-900 text-xs font-bold px-3 py-1 rounded-full">${i + 1} / ${state.playerCount}</div>
          <h2 class="text-2xl font-bold text-yellow-300 mb-4">${voter.name} の投票</h2>
          <p class="text-gray-400 mb-6">犯人だと思う人物を選んでください。（自分以外）</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="voteGrid">
            ${state.players.map(p => {
              const c = SCENARIO.characters.find(ac => ac.key === p.charKey);
              const isDisabled = p.id === voter.id;
              return `
                <button class="text-left p-4 rounded-lg border-2 transition-all duration-200 ${isDisabled ? 'bg-gray-700/50 border-gray-600 opacity-50 cursor-not-allowed' : 'bg-gray-900/70 border-gray-700 hover:border-yellow-400 hover:bg-gray-800'}" data-target="${c.key}" ${isDisabled ? 'disabled' : ''}>
                  <strong class="text-lg text-white">${c.name}</strong>
                  <small class="block text-gray-400">${p.name} の役</small>
                </button>`;
            }).join('')}
          </div>
          <div class="flex justify-end mt-6">
            <button class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg cursor-not-allowed" id="confirmVote" disabled>投票する</button>
          </div>
        </div>`;

      let selectedTarget = null;
      const confirmBtn = $('#confirmVote');
      screen.querySelectorAll('#voteGrid button').forEach(btn => {
        if (btn.disabled) return;
        btn.addEventListener('click', () => {
          screen.querySelectorAll('#voteGrid button').forEach(b => b.classList.remove('border-yellow-400', 'ring-2', 'ring-yellow-400'));
          btn.classList.add('border-yellow-400', 'ring-2', 'ring-yellow-400');
          selectedTarget = btn.dataset.target;
          confirmBtn.disabled = false;
          confirmBtn.classList.remove('bg-gray-600', 'cursor-not-allowed');
          confirmBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-400', 'text-gray-900');
        });
      });

      confirmBtn.onclick = () => {
        if (!selectedTarget) return;
        state.votes.push({ voterId: voter.id, targetCharKey: selectedTarget });
        if (i < state.playerCount - 1) {
          state.voteIdx++;
          openVeil(renderVote);
        } else {
          renderResult();
        }
      };
    }

    // Screen: Result
    function renderResult() {
        state.phase = 'result';
        setPhaseLabel('結果');
        const countMap = {};
        const keyToDisp = {};
        state.players.forEach(p => {
            const c = SCENARIO.characters.find(x => x.key === p.charKey);
            keyToDisp[c.key] = { char: c, player: p };
        });

        for (const v of state.votes) {
            countMap[v.targetCharKey] = (countMap[v.targetCharKey] || 0) + 1;
        }

        const rows = Object.keys(keyToDisp).map(k => ({
            key: k,
            disp: keyToDisp[k],
            votes: countMap[k] || 0
        })).sort((a, b) => b.votes - a.votes);

        const topVotes = rows[0]?.votes || 0;
        const tops = rows.filter(r => r.votes === topVotes);
        const mostVotedKey = (tops.length === 1) ? tops[0].key : null;
        const culpritKey = SCENARIO.culpritCharacterKey;
        const citizensWin = (mostVotedKey && mostVotedKey === culpritKey);
        
        let winnerText;
        if (mostVotedKey) {
            winnerText = citizensWin 
                ? '<span class="text-green-400">【市民チームの勝利】</span>真犯人（黒幕）を特定しました。' 
                : '<span class="text-red-400">【犯人チームの勝利】</span>投票で逃げ切りました。';
        } else {
            winnerText = '<span class="text-red-400">【犯人チームの勝利】</span>同票により犯人不在となりました。';
        }

        screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700">
            <h2 class="text-3xl font-bold text-yellow-300 mb-6 text-center">投票結果</h2>
            
            <!-- Vote Results -->
            <div class="space-y-3 mb-8">
                ${rows.map(r => `
                    <div class="bg-gray-900/70 p-3 rounded-lg flex items-center gap-4 ${r.key === mostVotedKey ? 'ring-2 ring-yellow-400' : ''}">
                        <div class="w-1/3">
                            <b class="text-white">${r.disp.char.name}</b>
                            <span class="text-xs text-gray-400 block">(${r.disp.player.name})</span>
                        </div>
                        <div class="w-2/3 flex items-center gap-4">
                            <div class="w-full bg-gray-700 rounded-full h-2.5">
                                <div class="bg-yellow-400 h-2.5 rounded-full" style="width: ${(r.votes / state.playerCount) * 100}%"></div>
                            </div>
                            <b class="text-lg text-white">${r.votes} 票</b>
                        </div>
                    </div>
                `).join('')}
            </div>

            <!-- Winner/Loser -->
            <div class="bg-gray-900/70 p-5 rounded-xl border border-gray-700 text-center mb-6">
                <h3 class="text-xl font-bold text-white mb-2">勝敗</h3>
                <p class="text-lg">${winnerText}</p>
            </div>

            <!-- Truth -->
            <div class="bg-gray-900/70 p-5 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-3">真相</h3>
                <p class="text-gray-300"><b>真犯人（黒幕）：</b> ${SCENARIO.characters.find(c => c.key === culpritKey).name}</p>
                <p class="mt-2 text-gray-300"><b>動機：</b> ${SCENARIO.truth.motive}</p>
                <p class="mt-2 text-gray-300"><b>犯行方法：</b> ${SCENARIO.truth.method}</p>
                <p class="mt-3 text-sm text-gray-400 bg-gray-800 p-3 rounded-md"><b>要約：</b> ${SCENARIO.truth.summary}</p>
            </div>

            <!-- Restart -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
                <button class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition" id="backToPick">シナリオ選択へ</button>
                <button class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-lg transition" id="restart">同じシナリオで遊ぶ</button>
            </div>
        </div>`;
        
        $('#restart').onclick = renderSetup;
        $('#backToPick').onclick = renderScenarioPicker;
    }


    // Initial boot
    renderScenarioPicker();
  </script>
</body>
</html>
