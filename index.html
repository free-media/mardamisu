<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>マーダーミステリー（オフライン簡易版）</title>
  <style>
    :root{
      --red:#8B0000; /* ダークレッド */
      --gold:#FFD700; /* ゴールド */
      --bg:#2C2C2C;   /* ダークグレー */
      --text:#FFFFFF; /* ホワイト */
      --muted:#999;
      --card:#3a3a3a;
      --accent:#b22222;
    }
    html,body{height:100%}
    body{ margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP"; background:linear-gradient(180deg,#1e1e1e,var(--bg)); color:var(--text) }
    header{ display:flex; align-items:center; justify-content:space-between; padding:10px 16px; background:var(--red); border-bottom:1px solid #000; position:sticky; top:0; z-index:3 }
    header h1{ font-size:16px; margin:0; letter-spacing:.02em }
    header .phase{ font-weight:700 }
    main{ max-width:980px; margin:24px auto; padding:0 16px }
    .card{ background:var(--card); border:1px solid #000; border-radius:12px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.35) }
    .row{ display:grid; gap:16px }
    .row.cols-2{ grid-template-columns: 1fr 1fr }
    @media (max-width: 800px){ .row.cols-2{ grid-template-columns: 1fr } }
    .btn{ appearance:none; border:0; padding:12px 16px; border-radius:10px; cursor:pointer; font-weight:700; color:#fff; background:var(--accent); box-shadow:0 6px 18px rgba(0,0,0,.35) }
    .btn.secondary{ background:#444 }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .btn:hover{ filter:brightness(1.08) }
    .btn:active{ transform: translateY(1px) }
    .bar{ height:10px; background:#444; border-radius:8px; overflow:hidden }
    .fill{ height:100%; background:linear-gradient(90deg, var(--gold), #ff9f1a) }
    .muted{ color:var(--muted) }
    .list{ margin:8px 0 0 0; padding:0 0 0 18px }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; background:#4a4a4a; font-size:12px; margin-right:6px }
    .grid{ display:grid; grid-template-columns: 1fr 2fr; gap:20px }
    @media (max-width: 860px){ .grid{ grid-template-columns: 1fr } }
    .char{ border-left:4px solid var(--gold); padding-left:12px }
    .evidence{ border-left:4px solid var(--red); padding-left:12px }
    .veil{ position:fixed; inset:0; background:#111; display:none; align-items:center; justify-content:center; z-index:9999 }
    .veil.active{ display:flex }
    .veil .panel{ background:#181818; border:1px solid #000; border-radius:16px; padding:24px; max-width:520px; text-align:center }
    .vote-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:12px }
    .vote-btn{ background:#4b1b1b; border:1px solid #5d2222; padding:14px; border-radius:12px; cursor:pointer; text-align:left }
    .vote-btn:hover{ filter:brightness(1.1) }
    .vote-btn small{ display:block; color:#ccc }
    .result-row{ display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px; background:#393939; margin-bottom:8px }
    .result-row.winner{ outline:2px solid var(--gold) }
    .footer-note{ font-size:12px; color:#bbb; margin-top:8px }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; background:#000; color:#fff; padding:2px 6px; border-radius:6px; border:1px solid #444 }
  </style>
</head>
<body>
  <header>
    <h1 id="title">シナリオ未選択</h1>
    <div class="phase" id="phaseLabel">シナリオ選択</div>
  </header>
  <main>
    <div id="screen"></div>
  </main>

  <div class="veil" id="veil">
    <div class="panel">
      <h2>画面を隠して端末を渡してください</h2>
      <p class="muted">次のプレイヤーが準備できたら、下のボタンを押してください。</p>
      <button class="btn" id="veilContinue">準備OK</button>
    </div>
  </div>

  <script>
    // ==============================
    // シナリオ ローダ
    // ==============================
    const titleEl = document.getElementById('title');
    const phaseLabel = document.getElementById('phaseLabel');
    const screen = document.getElementById('screen');
    const $ = (sel) => document.querySelector(sel);

    let SCENARIO = null; // 選択後に代入

    // 配布用想定: ./scenarios 以下にJSONを置く
    //  - crimson.json（クリムゾン・マンション殺人事件）
    //  - island.json（蒼き海の孤島殺人事件）
    const SCENARIO_FILES = {
      crimson: './scenarios/crimson.json',
      island: './scenarios/island.json',
    };

    // file:// で開く場合のフェッチ失敗を考慮してフォールバックも用意
    const FALLBACK = {
      crimson: {
        title: 'クリムゾン・マンション殺人事件',
        setting: { era:'現代', place:'山奥の豪華別荘「クリムゾン・マンション」', status:'嵐で孤立した別荘で殺人事件が発生' },
        victim: { name:'富豪の父親（別荘の主人）', cause:'毒殺', spot:'書斎', time:'夜10時頃', weapon:'毒入りのブランデー' },
        culpritCharacterKey: 'chef',
        evidences:[
          {id:1, title:'毒入りブランデーグラス', desc:'被害者の机上で発見。被害者の指紋のみ。'},
          {id:2, title:'破かれた遺言書の断片', desc:'暖炉付近で見つかる。遺言内容は不明。'},
          {id:3, title:'薬品の空き瓶', desc:'倉庫で発見。強い苦味のある薬品の痕跡。'},
        ],
        characters:[
          { key:'heir', name:'富豪の息子', role:'大学生', secret:'遺産の前借りを父に断られた。夜10時前に書斎付近にいた。', hint:'被害者は晩酌のブランデーにこだわっていた。' },
          { key:'secretary', name:'秘書', role:'被害者の右腕', secret:'重要な機密を握り遺言案に異議を唱えていた。', hint:'金庫の番号は被害者の誕生日と関連。' },
          { key:'chef', name:'料理人', role:'ベテラン', secret:'家族の医療費で借金。倉庫の棚を整理していた。', hint:'倉庫に強い苦味の薬品がある。' },
          { key:'doctor', name:'医師', role:'家族の友人', secret:'投資で損し借金。苦味の強い処方薬がある。', hint:'砂糖で苦味をごまかすのは難しい。' },
          { key:'lawyer', name:'弁護士', role:'遺言関与', secret:'最新案のコピーを紛失。', hint:'最新案では配分が大きく変更されていた。' },
          { key:'gardener', name:'庭師', role:'長年仕える', secret:'理不尽に叱責された過去。温室にいたと主張。', hint:'温室と書斎は屋外経由で短時間移動可能。' },
        ],
        truth:{
          summary:'犯人は料理人。倉庫の薬品をブランデーに混入し香りで苦味をごまかした。',
          motive:'家族の医療費で逼迫し援助を断られた。',
          method:'薬品を微量混入→ブランデーで覆い→書斎のグラスで飲ませた',
        }
      },
      island: {
        title: '蒼き海の孤島殺人事件',
        setting: { era:'現代', place:'南洋の孤島リゾートホテル', status:'大型台風で島が孤立' },
        victim: { name:'ホテルのオーナー', cause:'刺殺', spot:'オーナースイート', time:'深夜0時頃', weapon:'銀製のナイフ' },
        culpritCharacterKey: 'diver',
        evidences:[
          {id:1, title:'血のついたナイフ', desc:'胸に刺さったまま。指紋は拭き取り済み。'},
          {id:2, title:'破れた航海日誌', desc:'港の倉庫で発見。数ページ欠落。'},
          {id:3, title:'濡れた潜水服', desc:'深夜に使用された痕跡。まだ湿っている。'},
        ],
        characters:[
          { key:'diver', name:'プロダイバー', role:'観光客ガイド', secret:'違法サルベージを咎められていた', hint:'海から静かに接近できるが上陸時の物音に注意' },
          { key:'chef', name:'シェフ', role:'ホテル勤務', secret:'未払い続きで不満', hint:'キッチンの刃物は持出管理されている' },
          { key:'guest1', name:'小説家', role:'宿泊客', secret:'事件小説の取材を拒否された', hint:'演出のため怪しい行動を取ることも' },
          { key:'manager', name:'支配人', role:'ホテル管理', secret:'帳簿の不正を見つかり解雇通告', hint:'マスターキーを所持' },
          { key:'tourist', name:'旅行ブロガー', role:'宿泊客', secret:'悪評記事を準備し対立', hint:'直前に口論の目撃あり' },
          { key:'maid', name:'客室係', role:'清掃', secret:'客の高額品を盗んでしまった', hint:'夜間も廊下移動は可能だが足音が響く' },
        ],
        truth:{
          summary:'犯人はプロダイバー。台風の闇に紛れ海からバルコニー侵入し刺殺。',
          motive:'違法サルベージを守るための口封じ。',
          method:'潜水→バルコニー侵入→刺殺→柄を拭取→海へ撤退',
        }
      }
    };

    async function loadScenarioFromUrl(url, fallback){
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        return json;
      }catch(e){
        console.warn('シナリオの取得に失敗しました。フォールバックを使用します。', e);
        return structuredClone(fallback);
      }
    }

    function setPhaseLabel(text){ phaseLabel.textContent = text }

    // ==============================
    // アプリ状態
    // ==============================
    const state = {
      phase: 'pick',
      playerCount: 0,
      players: [], // {id,name,charKey}
      assignIdx: 0,
      voteIdx: 0,
      votes: [],
    };

    // ==============================
    // 画面：シナリオ選択
    // ==============================
    function renderScenarioPicker(){
      state.phase = 'pick'; setPhaseLabel('シナリオ選択'); titleEl.textContent = 'シナリオ未選択';
      screen.innerHTML = `
        <div class="card">
          <h2>シナリオを選択</h2>
          <div class="row cols-2" style="margin-top:10px">
            <div class="card" style="background:#333">
              <h3>クリムゾン・マンション殺人事件</h3>
              <p class="muted">嵐で孤立した山荘で起きた毒殺事件。</p>
              <div style="display:flex; gap:8px; flex-wrap:wrap">
                <button class="btn" id="pickCrimson">このシナリオを読み込む</button>
              </div>
            </div>
            <div class="card" style="background:#333">
              <h3>蒼き海の孤島殺人事件</h3>
              <p class="muted">台風で孤立した南の島のホテルで刺殺事件。</p>
              <div style="display:flex; gap:8px; flex-wrap:wrap">
                <button class="btn" id="pickIsland">このシナリオを読み込む</button>
              </div>
            </div>
          </div>

          <div class="card" style="background:#333; margin-top:12px">
            <h3>（任意）ローカルJSONを読み込む</h3>
            <p class="muted">独自シナリオJSONを読み込んで遊べます。</p>
            <input type="file" id="fileInput" accept="application/json" />
          </div>
        </div>`;

      $('#pickCrimson').onclick = async ()=>{
        SCENARIO = await loadScenarioFromUrl(SCENARIO_FILES.crimson, FALLBACK.crimson);
        afterScenarioLoaded();
      };
      $('#pickIsland').onclick = async ()=>{
        SCENARIO = await loadScenarioFromUrl(SCENARIO_FILES.island, FALLBACK.island);
        afterScenarioLoaded();
      };
      $('#fileInput').addEventListener('change', async (e)=>{
        const file = e.target.files?.[0]; if(!file) return;
        try{
          const text = await file.text();
          SCENARIO = JSON.parse(text);
          afterScenarioLoaded();
        }catch(err){ alert('JSONの読み込みに失敗しました'); }
      });
    }

    function afterScenarioLoaded(){
      titleEl.textContent = SCENARIO.title + '（オフライン簡易版）';
      renderSetup();
    }

    // ==============================
    // 以降：元のゲーム進行ロジック
    // ==============================

    function shuffle(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

    function renderSetup(){
      if(!SCENARIO){ return renderScenarioPicker(); }
      state.phase = 'setup'; setPhaseLabel('準備');
      screen.innerHTML = `
        <div class="card">
          <h2 style="margin-top:4px">ゲーム開始</h2>
          <p class="muted">この簡易版は<b>1台の端末</b>を交代で操作して進行します。サーバ通信はありません。</p>
          <div class="row cols-2" style="margin-top:14px">
            <div class="card" style="background:#333">
              <h3>プレイ人数を選択</h3>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 14px">
                ${[4,5,6].map(n=>`<button class=\"btn\" data-n=\"${n}\">${n} 人</button>`).join('')}
              </div>
              <div id="names"></div>
            </div>
            <div class="card" style="background:#333">
              <h3>シナリオ概要</h3>
              <p class="muted">${SCENARIO.setting.era}／${SCENARIO.setting.place}<br>${SCENARIO.setting.status}</p>
              <ul class="list">
                <li>被害者：${SCENARIO.victim.name}</li>
                <li>死因：${SCENARIO.victim.cause}</li>
                <li>発見場所：${SCENARIO.victim.spot}／発見時刻：${SCENARIO.victim.time}</li>
                <li>凶器：${SCENARIO.victim.weapon}</li>
              </ul>
              <p class="footer-note">※ 個人目標や密談は省略。全体議論のみのライト版です。</p>
            </div>
          </div>
        </div>`;

      screen.querySelectorAll('button[data-n]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const n = parseInt(btn.dataset.n,10); state.playerCount = n;
          const box = $('#names');
          box.innerHTML = `<div style=\"margin-top:6px\">
            <label class=\"muted\">プレイヤー名（空欄可。未入力は自動でP1..になります）</label>
            <div class=\"row cols-2\" style=\"margin-top:8px\">${Array.from({length:n}).map((_,i)=>`
              <input placeholder=\"プレイヤー${i+1}\" data-name-idx=\"${i}\" style=\"padding:10px;border-radius:10px;border:1px solid #555;background:#222;color:#fff\">`).join('')}</div>
            <div style=\"display:flex; gap:10px; margin-top:16px\">
              <button class=\"btn\" id=\"startAssign\">キャラクターを配役して開始</button>
              <button class=\"btn secondary\" id=\"randNames\">名前を自動入力</button>
              <button class=\"btn secondary\" id=\"changeScenario\">シナリオ変更</button>
            </div>
          </div>`;

          $('#randNames').onclick = ()=>{
            screen.querySelectorAll('[data-name-idx]').forEach((inp,i)=> inp.value = `プレイヤー${i+1}`);
          };
          $('#changeScenario').onclick = ()=>{ renderScenarioPicker(); };
          $('#startAssign').onclick = ()=>{
            const names = Array.from(screen.querySelectorAll('[data-name-idx]')).map((inp,i)=> inp.value.trim() || `プレイヤー${i+1}`);
            const chars = shuffle(SCENARIO.characters).slice(0, n);
            state.players = names.map((name,i)=> ({ id:i+1, name, charKey: chars[i].key }));
            state.assignIdx = 0; state.votes = []; state.voteIdx = 0;
            openVeil(()=> renderHandout());
          };
        });
      });
    }

    function openVeil(next){ const v = $('#veil'); v.classList.add('active'); $('#veilContinue').onclick = ()=>{ v.classList.remove('active'); next && next(); }; }

    function renderHandout(){
      state.phase = 'handout'; setPhaseLabel('ハンドアウト配布');
      const i = state.assignIdx; const player = state.players[i];
      const char = SCENARIO.characters.find(c=>c.key===player.charKey);
      screen.innerHTML = `
        <div class="card">
          <div class="pill">${i+1} / ${state.playerCount}</div>
          <h2>${player.name} のハンドアウト</h2>
          <div class="grid" style="margin-top:12px">
            <div class="char">
              <h3>${char.name}（${char.role}）</h3>
              <p><b>あなたの秘密</b><br>${char.secret}</p>
              <p class="muted">ヒント：${char.hint}</p>
            </div>
            <div class="evidence">
              <h3>事件概要（共通）</h3>
              <ul class="list">
                <li>被害者：${SCENARIO.victim.name}</li>
                <li>死因：${SCENARIO.victim.cause}</li>
                <li>発見場所：${SCENARIO.victim.spot}（${SCENARIO.victim.time}）</li>
                <li>凶器：${SCENARIO.victim.weapon}</li>
              </ul>
              <h4 style="margin-top:10px">初期証拠品</h4>
              <ul class="list">${SCENARIO.evidences.map(e=>`<li><b>${e.title}</b>：${e.desc}</li>`).join('')}</ul>
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:flex-end">
            ${i < state.playerCount-1 ? '<button class="btn" id="nextHandout">次の人へ</button>' : '<button class="btn" id="toOverview">全体共有へ</button>'}
          </div>
          <p class="footer-note">※ 受け渡し時は画面を隠してください（<span class="kbd">準備OK</span>）</p>
        </div>`;

      const next = (i < state.playerCount-1) ? ()=>{ state.assignIdx++; renderHandout(); } : renderOverview;
      const btnId = (i < state.playerCount-1) ? '#nextHandout' : '#toOverview';
      $(btnId).onclick = ()=> openVeil(next);
    }

    function renderOverview(){
      state.phase = 'overview'; setPhaseLabel('情報共有');
      const assignedChars = state.players.map(p => SCENARIO.characters.find(c=>c.key===p.charKey));
      screen.innerHTML = `
        <div class="card">
          <h2>全体共有</h2>
          <div class="row cols-2" style="margin-top:8px">
            <div class="card" style="background:#333">
              <h3>登場キャラクター（今回の配役）</h3>
              <ul class="list">${assignedChars.map(c=>`<li>${c.name}（${c.role}）</li>`).join('')}</ul>
            </div>
            <div class="card" style="background:#333">
              <h3>証拠品</h3>
              <ul class="list">${SCENARIO.evidences.map(e=>`<li><b>${e.title}</b>：${e.desc}</li>`).join('')}</ul>
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:space-between; align-items:center">
            <span class="muted">口頭でアリバイ・知っている情報を共有してください。</span>
            <button class="btn" id="toDebate">議論開始</button>
          </div>
        </div>`;
      $('#toDebate').onclick = renderDebate;
    }

    function renderDebate(){
      state.phase = 'debate'; setPhaseLabel('議論');
      screen.innerHTML = `
        <div class="card">
          <h2>議論フェーズ</h2>
          <p class="muted">この簡易版ではチャットやメモ機能はありません。口頭で議論してください。</p>
          <div class="row cols-2" style="margin-top:12px">
            <div class="card" style="background:#333">
              <h3>配役</h3>
              <ul class="list">${state.players.map(p=>{ const c = SCENARIO.characters.find(cc=>cc.key===p.charKey); return `<li>${p.name}：${c.name}</li>` }).join('')}</ul>
            </div>
            <div class="card" style="background:#333">
              <h3>証拠品早見</h3>
              <ul class="list">${SCENARIO.evidences.map(e=>`<li><b>${e.title}</b>：${e.desc}</li>`).join('')}</ul>
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:flex-end">
            <button class="btn" id="toVote">投票へ</button>
          </div>
        </div>`;
      $('#toVote').onclick = ()=>{ state.voteIdx = 0; state.votes = []; openVeil(renderVote); };
    }

    function renderVote(){
      state.phase = 'vote'; setPhaseLabel('投票');
      const i = state.voteIdx; const voter = state.players[i];
      const assignedChars = state.players.map(p => SCENARIO.characters.find(c=>c.key===p.charKey));
      screen.innerHTML = `
        <div class="card">
          <div class="pill">${i+1} / ${state.playerCount}</div>
          <h2>${voter.name} の投票</h2>
          <p>犯人だと思うキャラクターを選んでください。（自分以外）</p>
          <div class="vote-grid" id="voteGrid">
            ${state.players.map(p=>{ const c = assignedChars.find(ac=>ac.key===p.charKey); const dis = (p.id===voter.id)?'data-disabled=\'1\'':''; return `<button class=\"vote-btn\" data-target=\"${c.key}\" ${dis}><strong>${c.name}</strong><small>${p.name} の役</small></button>` }).join('')}
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:flex-end">
            <button class="btn" id="confirmVote" disabled>投票する</button>
          </div>
          <p class="footer-note">※ 受け渡し時は画面を隠してください（<span class="kbd">準備OK</span>）</p>
        </div>`;

      let selected = null;
      screen.querySelectorAll('.vote-btn').forEach(btn=>{
        const isDis = btn.dataset.disabled==='1';
        if(isDis){ btn.style.opacity=.5; btn.style.pointerEvents='none'; }
        btn.addEventListener('click', ()=>{ if(isDis) return; screen.querySelectorAll('.vote-btn').forEach(b=> b.style.outline='none'); btn.style.outline='2px solid var(--gold)'; selected = btn.dataset.target; $('#confirmVote').disabled = false; });
      });

      $('#confirmVote').onclick = ()=>{
        if(!selected) return; state.votes.push({ voterId: voter.id, targetCharKey: selected });
        if(i < state.playerCount-1){ state.voteIdx++; openVeil(renderVote); } else { renderResult(); }
      };
    }

    function renderResult(){
      state.phase = 'result'; setPhaseLabel('結果');
      const countMap = {}; const keyToDisp = {};
      state.players.forEach(p=>{ const c = SCENARIO.characters.find(x=>x.key===p.charKey); keyToDisp[c.key] = {char:c, player:p}; });
      for(const v of state.votes){ countMap[v.targetCharKey] = (countMap[v.targetCharKey]||0)+1; }
      const rows = Object.keys(keyToDisp).map(k=>({ key:k, disp:keyToDisp[k], votes:countMap[k]||0 })).sort((a,b)=> b.votes-a.votes);
      const topVotes = rows[0]?.votes || 0; const tops = rows.filter(r=> r.votes===topVotes); const mostKey = (tops.length===1)? tops[0].key : null;
      const culpritKey = SCENARIO.culpritCharacterKey; const citizensWin = (mostKey && mostKey===culpritKey);

      screen.innerHTML = `
        <div class="card">
          <h2>投票結果</h2>
          <div style="margin:12px 0">
            ${rows.map(r=>{ const cls = (r.key===mostKey)?'result-row winner':'result-row'; return `<div class=\"${cls}\"><div style=\"min-width:150px\"><b>${r.disp.char.name}</b><br><span class=\"muted\">(${r.disp.player.name})</span></div><div class=\"bar\" style=\"flex:1\"><div class=\"fill\" style=\"width:${(r.votes/state.playerCount)*100}%\"></div></div><div style=\"min-width:60px; text-align:right\"><b>${r.votes}</b> 票</div></div>` }).join('')}
          </div>
          <div class="card" style="background:#333; margin-top:14px">
            <h3>勝敗</h3>
            ${mostKey ? `<p>最多票：<b>${keyToDisp[mostKey].char.name}</b></p><p>${citizensWin ? '市民チームの勝利！真犯人を特定しました。' : '犯人の勝利！投票で逃げ切りました。'}</p>` : `<p>同票により犯人不在。<b>犯人の勝利！</b></p>`}
          </div>
          <div class="card" style="background:#333; margin-top:14px">
            <h3>真相</h3>
            <p><b>真犯人：</b>${SCENARIO.characters.find(c=>c.key===culpritKey).name}</p>
            <p><b>動機：</b>${SCENARIO.truth.motive}</p>
            <p><b>犯行方法：</b>${SCENARIO.truth.method}</p>
            <p class="muted">要約：${SCENARIO.truth.summary}</p>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:space-between; align-items:center">
            <span class="muted">別シナリオで遊ぶには、シナリオ選択に戻ってください。</span>
            <div>
              <button class="btn secondary" id="backToPick">シナリオ選択へ</button>
              <button class="btn" id="restart">同じシナリオで最初から</button>
            </div>
          </div>
        </div>`;
      $('#restart').onclick = renderSetup; $('#backToPick').onclick = renderScenarioPicker;
    }

    // 起動
    renderScenarioPicker();
  </script>

  <!--
  =============================================
  置き場所とファイル内容の例（このHTMLとは別ファイル）
  ---------------------------------------------
  /scenarios/crimson.json
  {
    "title": "クリムゾン・マンション殺人事件",
    "setting": {"era":"現代","place":"山奥の豪華別荘『クリムゾン・マンション』","status":"嵐で孤立した別荘で殺人事件が発生"},
    "victim": {"name":"富豪の父親（別荘の主人）","cause":"毒殺","spot":"書斎","time":"夜10時頃","weapon":"毒入りのブランデー"},
    "culpritCharacterKey":"chef",
    "evidences":[
      {"id":1,"title":"毒入りブランデーグラス","desc":"被害者の机上で発見。被害者の指紋のみ。"},
      {"id":2,"title":"破かれた遺言書の断片","desc":"暖炉付近で見つかる。遺言内容は不明。"},
      {"id":3,"title":"薬品の空き瓶","desc":"倉庫で発見。強い苦味の薬品の痕跡。"}
    ],
    "characters":[
      {"key":"heir","name":"富豪の息子","role":"大学生","secret":"遺産の前借りを父に断られた。夜10時前に書斎付近にいた。","hint":"被害者は晩酌のブランデーにこだわっていた。"},
      {"key":"secretary","name":"秘書","role":"被害者の右腕","secret":"重要な機密を握り遺言案に異議を唱えていた。","hint":"金庫の番号は被害者の誕生日と関連。"},
      {"key":"chef","name":"料理人","role":"ベテラン","secret":"家族の医療費で借金。倉庫の棚を整理していた。","hint":"倉庫に強い苦味の薬品がある。"},
      {"key":"doctor","name":"医師","role":"家族の友人","secret":"投資で損し借金。苦味の強い処方薬がある。","hint":"砂糖で苦味をごまかすのは難しい。"},
      {"key":"lawyer","name":"弁護士","role":"遺言関与","secret":"最新案のコピーを紛失。","hint":"最新案では配分が大きく変更されていた。"},
      {"key":"gardener","name":"庭師","role":"長年仕える","secret":"理不尽に叱責された過去。温室にいたと主張。","hint":"温室と書斎は屋外経由で短時間移動可能。"}
    ],
    "truth": {"summary":"犯人は料理人。倉庫の薬品をブランデーに混入し香りで苦味をごまかした。","motive":"家族の医療費で逼迫し援助を断られた。","method":"薬品を微量混入→ブランデーで覆い→書斎のグラスで飲ませた"}
  }

  /scenarios/island.json
  {
    "title":"蒼き海の孤島殺人事件",
    "setting": {"era":"現代","place":"南洋の孤島リゾートホテル","status":"大型台風で島が孤立"},
    "victim": {"name":"ホテルのオーナー","cause":"刺殺","spot":"オーナースイート","time":"深夜0時頃","weapon":"銀製のナイフ"},
    "culpritCharacterKey":"diver",
    "evidences":[
      {"id":1,"title":"血のついたナイフ","desc":"胸に刺さったまま。指紋は拭き取り済み。"},
      {"id":2,"title":"破れた航海日誌","desc":"港の倉庫で発見。数ページ欠落。"},
      {"id":3,"title":"濡れた潜水服","desc":"深夜に使用された痕跡。まだ湿っている。"}
    ],
    "characters":[
      {"key":"diver","name":"プロダイバー","role":"観光客ガイド","secret":"違法サルベージを咎められていた","hint":"海から静かに接近できるが上陸時の物音に注意"},
      {"key":"chef","name":"シェフ","role":"ホテル勤務","secret":"未払い続きで不満","hint":"キッチンの刃物は持出管理されている"},
      {"key":"guest1","name":"小説家","role":"宿泊客","secret":"事件小説の取材を拒否された","hint":"演出のため怪しい行動を取ることも"},
      {"key":"manager","name":"支配人","role":"ホテル管理","secret":"帳簿の不正を見つかり解雇通告","hint":"マスターキーを所持"},
      {"key":"tourist","name":"旅行ブロガー","role":"宿泊客","secret":"悪評記事を準備し対立","hint":"直前に口論の目撃あり"},
      {"key":"maid","name":"客室係","role":"清掃","secret":"客の高額品を盗んでしまった","hint":"夜間も廊下移動は可能だが足音が響く"}
    ],
    "truth": {"summary":"犯人はプロダイバー。台風の闇に紛れ海からバルコニー侵入し刺殺。","motive":"違法サルベージを守るための口封じ。","method":"潜水→バルコニー侵入→刺殺→柄を拭取→海へ撤退"}
  }
  =============================================
  -->
</body>
</html><!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>マーダーミステリー（オフライン簡易版）</title>
  <style>
    :root{
      --red:#8B0000; /* ダークレッド */
      --gold:#FFD700; /* ゴールド */
      --bg:#2C2C2C;   /* ダークグレー */
      --text:#FFFFFF; /* ホワイト */
      --muted:#999;
      --card:#3a3a3a;
      --accent:#b22222;
    }
    html,body{height:100%}
    body{ margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP"; background:linear-gradient(180deg,#1e1e1e,var(--bg)); color:var(--text) }
    header{ display:flex; align-items:center; justify-content:space-between; padding:10px 16px; background:var(--red); border-bottom:1px solid #000; position:sticky; top:0; z-index:3 }
    header h1{ font-size:16px; margin:0; letter-spacing:.02em }
    header .phase{ font-weight:700 }
    main{ max-width:980px; margin:24px auto; padding:0 16px }
    .card{ background:var(--card); border:1px solid #000; border-radius:12px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.35) }
    .row{ display:grid; gap:16px }
    .row.cols-2{ grid-template-columns: 1fr 1fr }
    @media (max-width: 800px){ .row.cols-2{ grid-template-columns: 1fr } }
    .btn{ appearance:none; border:0; padding:12px 16px; border-radius:10px; cursor:pointer; font-weight:700; color:#fff; background:var(--accent); box-shadow:0 6px 18px rgba(0,0,0,.35) }
    .btn.secondary{ background:#444 }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .btn:hover{ filter:brightness(1.08) }
    .btn:active{ transform: translateY(1px) }
    .bar{ height:10px; background:#444; border-radius:8px; overflow:hidden }
    .fill{ height:100%; background:linear-gradient(90deg, var(--gold), #ff9f1a) }
    .muted{ color:var(--muted) }
    .list{ margin:8px 0 0 0; padding:0 0 0 18px }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; background:#4a4a4a; font-size:12px; margin-right:6px }
    .grid{ display:grid; grid-template-columns: 1fr 2fr; gap:20px }
    @media (max-width: 860px){ .grid{ grid-template-columns: 1fr } }
    .char{ border-left:4px solid var(--gold); padding-left:12px }
    .evidence{ border-left:4px solid var(--red); padding-left:12px }
    .veil{ position:fixed; inset:0; background:#111; display:none; align-items:center; justify-content:center; z-index:9999 }
    .veil.active{ display:flex }
    .veil .panel{ background:#181818; border:1px solid #000; border-radius:16px; padding:24px; max-width:520px; text-align:center }
    .vote-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:12px }
    .vote-btn{ background:#4b1b1b; border:1px solid #5d2222; padding:14px; border-radius:12px; cursor:pointer; text-align:left }
    .vote-btn:hover{ filter:brightness(1.1) }
    .vote-btn small{ display:block; color:#ccc }
    .result-row{ display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px; background:#393939; margin-bottom:8px }
    .result-row.winner{ outline:2px solid var(--gold) }
    .footer-note{ font-size:12px; color:#bbb; margin-top:8px }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; background:#000; color:#fff; padding:2px 6px; border-radius:6px; border:1px solid #444 }
  </style>
</head>
<body>
  <header>
    <h1 id="title">シナリオ未選択</h1>
    <div class="phase" id="phaseLabel">シナリオ選択</div>
  </header>
  <main>
    <div id="screen"></div>
  </main>

  <div class="veil" id="veil">
    <div class="panel">
      <h2>画面を隠して端末を渡してください</h2>
      <p class="muted">次のプレイヤーが準備できたら、下のボタンを押してください。</p>
      <button class="btn" id="veilContinue">準備OK</button>
    </div>
  </div>

  <script>
    // ==============================
    // シナリオ ローダ
    // ==============================
    const titleEl = document.getElementById('title');
    const phaseLabel = document.getElementById('phaseLabel');
    const screen = document.getElementById('screen');
    const $ = (sel) => document.querySelector(sel);

    let SCENARIO = null; // 選択後に代入

    // 配布用想定: ./scenarios 以下にJSONを置く
    //  - crimson.json（クリムゾン・マンション殺人事件）
    //  - island.json（蒼き海の孤島殺人事件）
    const SCENARIO_FILES = {
      crimson: './scenarios/crimson.json',
      island: './scenarios/island.json',
    };

    // file:// で開く場合のフェッチ失敗を考慮してフォールバックも用意
    const FALLBACK = {
      crimson: {
        title: 'クリムゾン・マンション殺人事件',
        setting: { era:'現代', place:'山奥の豪華別荘「クリムゾン・マンション」', status:'嵐で孤立した別荘で殺人事件が発生' },
        victim: { name:'富豪の父親（別荘の主人）', cause:'毒殺', spot:'書斎', time:'夜10時頃', weapon:'毒入りのブランデー' },
        culpritCharacterKey: 'chef',
        evidences:[
          {id:1, title:'毒入りブランデーグラス', desc:'被害者の机上で発見。被害者の指紋のみ。'},
          {id:2, title:'破かれた遺言書の断片', desc:'暖炉付近で見つかる。遺言内容は不明。'},
          {id:3, title:'薬品の空き瓶', desc:'倉庫で発見。強い苦味のある薬品の痕跡。'},
        ],
        characters:[
          { key:'heir', name:'富豪の息子', role:'大学生', secret:'遺産の前借りを父に断られた。夜10時前に書斎付近にいた。', hint:'被害者は晩酌のブランデーにこだわっていた。' },
          { key:'secretary', name:'秘書', role:'被害者の右腕', secret:'重要な機密を握り遺言案に異議を唱えていた。', hint:'金庫の番号は被害者の誕生日と関連。' },
          { key:'chef', name:'料理人', role:'ベテラン', secret:'家族の医療費で借金。倉庫の棚を整理していた。', hint:'倉庫に強い苦味の薬品がある。' },
          { key:'doctor', name:'医師', role:'家族の友人', secret:'投資で損し借金。苦味の強い処方薬がある。', hint:'砂糖で苦味をごまかすのは難しい。' },
          { key:'lawyer', name:'弁護士', role:'遺言関与', secret:'最新案のコピーを紛失。', hint:'最新案では配分が大きく変更されていた。' },
          { key:'gardener', name:'庭師', role:'長年仕える', secret:'理不尽に叱責された過去。温室にいたと主張。', hint:'温室と書斎は屋外経由で短時間移動可能。' },
        ],
        truth:{
          summary:'犯人は料理人。倉庫の薬品をブランデーに混入し香りで苦味をごまかした。',
          motive:'家族の医療費で逼迫し援助を断られた。',
          method:'薬品を微量混入→ブランデーで覆い→書斎のグラスで飲ませた',
        }
      },
      island: {
        title: '蒼き海の孤島殺人事件',
        setting: { era:'現代', place:'南洋の孤島リゾートホテル', status:'大型台風で島が孤立' },
        victim: { name:'ホテルのオーナー', cause:'刺殺', spot:'オーナースイート', time:'深夜0時頃', weapon:'銀製のナイフ' },
        culpritCharacterKey: 'diver',
        evidences:[
          {id:1, title:'血のついたナイフ', desc:'胸に刺さったまま。指紋は拭き取り済み。'},
          {id:2, title:'破れた航海日誌', desc:'港の倉庫で発見。数ページ欠落。'},
          {id:3, title:'濡れた潜水服', desc:'深夜に使用された痕跡。まだ湿っている。'},
        ],
        characters:[
          { key:'diver', name:'プロダイバー', role:'観光客ガイド', secret:'違法サルベージを咎められていた', hint:'海から静かに接近できるが上陸時の物音に注意' },
          { key:'chef', name:'シェフ', role:'ホテル勤務', secret:'未払い続きで不満', hint:'キッチンの刃物は持出管理されている' },
          { key:'guest1', name:'小説家', role:'宿泊客', secret:'事件小説の取材を拒否された', hint:'演出のため怪しい行動を取ることも' },
          { key:'manager', name:'支配人', role:'ホテル管理', secret:'帳簿の不正を見つかり解雇通告', hint:'マスターキーを所持' },
          { key:'tourist', name:'旅行ブロガー', role:'宿泊客', secret:'悪評記事を準備し対立', hint:'直前に口論の目撃あり' },
          { key:'maid', name:'客室係', role:'清掃', secret:'客の高額品を盗んでしまった', hint:'夜間も廊下移動は可能だが足音が響く' },
        ],
        truth:{
          summary:'犯人はプロダイバー。台風の闇に紛れ海からバルコニー侵入し刺殺。',
          motive:'違法サルベージを守るための口封じ。',
          method:'潜水→バルコニー侵入→刺殺→柄を拭取→海へ撤退',
        }
      }
    };

    async function loadScenarioFromUrl(url, fallback){
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        return json;
      }catch(e){
        console.warn('シナリオの取得に失敗しました。フォールバックを使用します。', e);
        return structuredClone(fallback);
      }
    }

    function setPhaseLabel(text){ phaseLabel.textContent = text }

    // ==============================
    // アプリ状態
    // ==============================
    const state = {
      phase: 'pick',
      playerCount: 0,
      players: [], // {id,name,charKey}
      assignIdx: 0,
      voteIdx: 0,
      votes: [],
    };

    // ==============================
    // 画面：シナリオ選択
    // ==============================
    function renderScenarioPicker(){
      state.phase = 'pick'; setPhaseLabel('シナリオ選択'); titleEl.textContent = 'シナリオ未選択';
      screen.innerHTML = `
        <div class="card">
          <h2>シナリオを選択</h2>
          <div class="row cols-2" style="margin-top:10px">
            <div class="card" style="background:#333">
              <h3>クリムゾン・マンション殺人事件</h3>
              <p class="muted">嵐で孤立した山荘で起きた毒殺事件。</p>
              <div style="display:flex; gap:8px; flex-wrap:wrap">
                <button class="btn" id="pickCrimson">このシナリオを読み込む</button>
              </div>
            </div>
            <div class="card" style="background:#333">
              <h3>蒼き海の孤島殺人事件</h3>
              <p class="muted">台風で孤立した南の島のホテルで刺殺事件。</p>
              <div style="display:flex; gap:8px; flex-wrap:wrap">
                <button class="btn" id="pickIsland">このシナリオを読み込む</button>
              </div>
            </div>
          </div>

          <div class="card" style="background:#333; margin-top:12px">
            <h3>（任意）ローカルJSONを読み込む</h3>
            <p class="muted">独自シナリオJSONを読み込んで遊べます。</p>
            <input type="file" id="fileInput" accept="application/json" />
          </div>
        </div>`;

      $('#pickCrimson').onclick = async ()=>{
        SCENARIO = await loadScenarioFromUrl(SCENARIO_FILES.crimson, FALLBACK.crimson);
        afterScenarioLoaded();
      };
      $('#pickIsland').onclick = async ()=>{
        SCENARIO = await loadScenarioFromUrl(SCENARIO_FILES.island, FALLBACK.island);
        afterScenarioLoaded();
      };
      $('#fileInput').addEventListener('change', async (e)=>{
        const file = e.target.files?.[0]; if(!file) return;
        try{
          const text = await file.text();
          SCENARIO = JSON.parse(text);
          afterScenarioLoaded();
        }catch(err){ alert('JSONの読み込みに失敗しました'); }
      });
    }

    function afterScenarioLoaded(){
      titleEl.textContent = SCENARIO.title + '（オフライン簡易版）';
      renderSetup();
    }

    // ==============================
    // 以降：元のゲーム進行ロジック
    // ==============================

    function shuffle(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

    function renderSetup(){
      if(!SCENARIO){ return renderScenarioPicker(); }
      state.phase = 'setup'; setPhaseLabel('準備');
      screen.innerHTML = `
        <div class="card">
          <h2 style="margin-top:4px">ゲーム開始</h2>
          <p class="muted">この簡易版は<b>1台の端末</b>を交代で操作して進行します。サーバ通信はありません。</p>
          <div class="row cols-2" style="margin-top:14px">
            <div class="card" style="background:#333">
              <h3>プレイ人数を選択</h3>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 14px">
                ${[4,5,6].map(n=>`<button class=\"btn\" data-n=\"${n}\">${n} 人</button>`).join('')}
              </div>
              <div id="names"></div>
            </div>
            <div class="card" style="background:#333">
              <h3>シナリオ概要</h3>
              <p class="muted">${SCENARIO.setting.era}／${SCENARIO.setting.place}<br>${SCENARIO.setting.status}</p>
              <ul class="list">
                <li>被害者：${SCENARIO.victim.name}</li>
                <li>死因：${SCENARIO.victim.cause}</li>
                <li>発見場所：${SCENARIO.victim.spot}／発見時刻：${SCENARIO.victim.time}</li>
                <li>凶器：${SCENARIO.victim.weapon}</li>
              </ul>
              <p class="footer-note">※ 個人目標や密談は省略。全体議論のみのライト版です。</p>
            </div>
          </div>
        </div>`;

      screen.querySelectorAll('button[data-n]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const n = parseInt(btn.dataset.n,10); state.playerCount = n;
          const box = $('#names');
          box.innerHTML = `<div style=\"margin-top:6px\">
            <label class=\"muted\">プレイヤー名（空欄可。未入力は自動でP1..になります）</label>
            <div class=\"row cols-2\" style=\"margin-top:8px\">${Array.from({length:n}).map((_,i)=>`
              <input placeholder=\"プレイヤー${i+1}\" data-name-idx=\"${i}\" style=\"padding:10px;border-radius:10px;border:1px solid #555;background:#222;color:#fff\">`).join('')}</div>
            <div style=\"display:flex; gap:10px; margin-top:16px\">
              <button class=\"btn\" id=\"startAssign\">キャラクターを配役して開始</button>
              <button class=\"btn secondary\" id=\"randNames\">名前を自動入力</button>
              <button class=\"btn secondary\" id=\"changeScenario\">シナリオ変更</button>
            </div>
          </div>`;

          $('#randNames').onclick = ()=>{
            screen.querySelectorAll('[data-name-idx]').forEach((inp,i)=> inp.value = `プレイヤー${i+1}`);
          };
          $('#changeScenario').onclick = ()=>{ renderScenarioPicker(); };
          $('#startAssign').onclick = ()=>{
            const names = Array.from(screen.querySelectorAll('[data-name-idx]')).map((inp,i)=> inp.value.trim() || `プレイヤー${i+1}`);
            const chars = shuffle(SCENARIO.characters).slice(0, n);
            state.players = names.map((name,i)=> ({ id:i+1, name, charKey: chars[i].key }));
            state.assignIdx = 0; state.votes = []; state.voteIdx = 0;
            openVeil(()=> renderHandout());
          };
        });
      });
    }

    function openVeil(next){ const v = $('#veil'); v.classList.add('active'); $('#veilContinue').onclick = ()=>{ v.classList.remove('active'); next && next(); }; }

    function renderHandout(){
      state.phase = 'handout'; setPhaseLabel('ハンドアウト配布');
      const i = state.assignIdx; const player = state.players[i];
      const char = SCENARIO.characters.find(c=>c.key===player.charKey);
      screen.innerHTML = `
        <div class="card">
          <div class="pill">${i+1} / ${state.playerCount}</div>
          <h2>${player.name} のハンドアウト</h2>
          <div class="grid" style="margin-top:12px">
            <div class="char">
              <h3>${char.name}（${char.role}）</h3>
              <p><b>あなたの秘密</b><br>${char.secret}</p>
              <p class="muted">ヒント：${char.hint}</p>
            </div>
            <div class="evidence">
              <h3>事件概要（共通）</h3>
              <ul class="list">
                <li>被害者：${SCENARIO.victim.name}</li>
                <li>死因：${SCENARIO.victim.cause}</li>
                <li>発見場所：${SCENARIO.victim.spot}（${SCENARIO.victim.time}）</li>
                <li>凶器：${SCENARIO.victim.weapon}</li>
              </ul>
              <h4 style="margin-top:10px">初期証拠品</h4>
              <ul class="list">${SCENARIO.evidences.map(e=>`<li><b>${e.title}</b>：${e.desc}</li>`).join('')}</ul>
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:flex-end">
            ${i < state.playerCount-1 ? '<button class="btn" id="nextHandout">次の人へ</button>' : '<button class="btn" id="toOverview">全体共有へ</button>'}
          </div>
          <p class="footer-note">※ 受け渡し時は画面を隠してください（<span class="kbd">準備OK</span>）</p>
        </div>`;

      const next = (i < state.playerCount-1) ? ()=>{ state.assignIdx++; renderHandout(); } : renderOverview;
      const btnId = (i < state.playerCount-1) ? '#nextHandout' : '#toOverview';
      $(btnId).onclick = ()=> openVeil(next);
    }

    function renderOverview(){
      state.phase = 'overview'; setPhaseLabel('情報共有');
      const assignedChars = state.players.map(p => SCENARIO.characters.find(c=>c.key===p.charKey));
      screen.innerHTML = `
        <div class="card">
          <h2>全体共有</h2>
          <div class="row cols-2" style="margin-top:8px">
            <div class="card" style="background:#333">
              <h3>登場キャラクター（今回の配役）</h3>
              <ul class="list">${assignedChars.map(c=>`<li>${c.name}（${c.role}）</li>`).join('')}</ul>
            </div>
            <div class="card" style="background:#333">
              <h3>証拠品</h3>
              <ul class="list">${SCENARIO.evidences.map(e=>`<li><b>${e.title}</b>：${e.desc}</li>`).join('')}</ul>
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:space-between; align-items:center">
            <span class="muted">口頭でアリバイ・知っている情報を共有してください。</span>
            <button class="btn" id="toDebate">議論開始</button>
          </div>
        </div>`;
      $('#toDebate').onclick = renderDebate;
    }

    function renderDebate(){
      state.phase = 'debate'; setPhaseLabel('議論');
      screen.innerHTML = `
        <div class="card">
          <h2>議論フェーズ</h2>
          <p class="muted">この簡易版ではチャットやメモ機能はありません。口頭で議論してください。</p>
          <div class="row cols-2" style="margin-top:12px">
            <div class="card" style="background:#333">
              <h3>配役</h3>
              <ul class="list">${state.players.map(p=>{ const c = SCENARIO.characters.find(cc=>cc.key===p.charKey); return `<li>${p.name}：${c.name}</li>` }).join('')}</ul>
            </div>
            <div class="card" style="background:#333">
              <h3>証拠品早見</h3>
              <ul class="list">${SCENARIO.evidences.map(e=>`<li><b>${e.title}</b>：${e.desc}</li>`).join('')}</ul>
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:flex-end">
            <button class="btn" id="toVote">投票へ</button>
          </div>
        </div>`;
      $('#toVote').onclick = ()=>{ state.voteIdx = 0; state.votes = []; openVeil(renderVote); };
    }

    function renderVote(){
      state.phase = 'vote'; setPhaseLabel('投票');
      const i = state.voteIdx; const voter = state.players[i];
      const assignedChars = state.players.map(p => SCENARIO.characters.find(c=>c.key===p.charKey));
      screen.innerHTML = `
        <div class="card">
          <div class="pill">${i+1} / ${state.playerCount}</div>
          <h2>${voter.name} の投票</h2>
          <p>犯人だと思うキャラクターを選んでください。（自分以外）</p>
          <div class="vote-grid" id="voteGrid">
            ${state.players.map(p=>{ const c = assignedChars.find(ac=>ac.key===p.charKey); const dis = (p.id===voter.id)?'data-disabled=\'1\'':''; return `<button class=\"vote-btn\" data-target=\"${c.key}\" ${dis}><strong>${c.name}</strong><small>${p.name} の役</small></button>` }).join('')}
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:flex-end">
            <button class="btn" id="confirmVote" disabled>投票する</button>
          </div>
          <p class="footer-note">※ 受け渡し時は画面を隠してください（<span class="kbd">準備OK</span>）</p>
        </div>`;

      let selected = null;
      screen.querySelectorAll('.vote-btn').forEach(btn=>{
        const isDis = btn.dataset.disabled==='1';
        if(isDis){ btn.style.opacity=.5; btn.style.pointerEvents='none'; }
        btn.addEventListener('click', ()=>{ if(isDis) return; screen.querySelectorAll('.vote-btn').forEach(b=> b.style.outline='none'); btn.style.outline='2px solid var(--gold)'; selected = btn.dataset.target; $('#confirmVote').disabled = false; });
      });

      $('#confirmVote').onclick = ()=>{
        if(!selected) return; state.votes.push({ voterId: voter.id, targetCharKey: selected });
        if(i < state.playerCount-1){ state.voteIdx++; openVeil(renderVote); } else { renderResult(); }
      };
    }

    function renderResult(){
      state.phase = 'result'; setPhaseLabel('結果');
      const countMap = {}; const keyToDisp = {};
      state.players.forEach(p=>{ const c = SCENARIO.characters.find(x=>x.key===p.charKey); keyToDisp[c.key] = {char:c, player:p}; });
      for(const v of state.votes){ countMap[v.targetCharKey] = (countMap[v.targetCharKey]||0)+1; }
      const rows = Object.keys(keyToDisp).map(k=>({ key:k, disp:keyToDisp[k], votes:countMap[k]||0 })).sort((a,b)=> b.votes-a.votes);
      const topVotes = rows[0]?.votes || 0; const tops = rows.filter(r=> r.votes===topVotes); const mostKey = (tops.length===1)? tops[0].key : null;
      const culpritKey = SCENARIO.culpritCharacterKey; const citizensWin = (mostKey && mostKey===culpritKey);

      screen.innerHTML = `
        <div class="card">
          <h2>投票結果</h2>
          <div style="margin:12px 0">
            ${rows.map(r=>{ const cls = (r.key===mostKey)?'result-row winner':'result-row'; return `<div class=\"${cls}\"><div style=\"min-width:150px\"><b>${r.disp.char.name}</b><br><span class=\"muted\">(${r.disp.player.name})</span></div><div class=\"bar\" style=\"flex:1\"><div class=\"fill\" style=\"width:${(r.votes/state.playerCount)*100}%\"></div></div><div style=\"min-width:60px; text-align:right\"><b>${r.votes}</b> 票</div></div>` }).join('')}
          </div>
          <div class="card" style="background:#333; margin-top:14px">
            <h3>勝敗</h3>
            ${mostKey ? `<p>最多票：<b>${keyToDisp[mostKey].char.name}</b></p><p>${citizensWin ? '市民チームの勝利！真犯人を特定しました。' : '犯人の勝利！投票で逃げ切りました。'}</p>` : `<p>同票により犯人不在。<b>犯人の勝利！</b></p>`}
          </div>
          <div class="card" style="background:#333; margin-top:14px">
            <h3>真相</h3>
            <p><b>真犯人：</b>${SCENARIO.characters.find(c=>c.key===culpritKey).name}</p>
            <p><b>動機：</b>${SCENARIO.truth.motive}</p>
            <p><b>犯行方法：</b>${SCENARIO.truth.method}</p>
            <p class="muted">要約：${SCENARIO.truth.summary}</p>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:space-between; align-items:center">
            <span class="muted">別シナリオで遊ぶには、シナリオ選択に戻ってください。</span>
            <div>
              <button class="btn secondary" id="backToPick">シナリオ選択へ</button>
              <button class="btn" id="restart">同じシナリオで最初から</button>
            </div>
          </div>
        </div>`;
      $('#restart').onclick = renderSetup; $('#backToPick').onclick = renderScenarioPicker;
    }

    // 起動
    renderScenarioPicker();
  </script>
</body>
</html>
