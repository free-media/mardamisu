<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>マーダーミステリー（オフライン簡易版）</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
    }
    .font-noto {
        font-family: 'Noto Sans JP', sans-serif;
    }
  </style>
  <script src="scenarios.js"></script>
</head>
<body class="bg-gray-900 text-white font-noto">
  <!-- Header -->
  <header class="bg-red-900/80 backdrop-blur-sm sticky top-0 z-10 border-b border-black/50">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <h1 id="title" class="text-lg font-bold text-yellow-300 tracking-wider">シナリオ未選択</h1>
            <div id="phaseLabel" class="text-sm font-semibold bg-white/20 text-white py-1 px-3 rounded-full">シナリオ選択</div>
        </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
    <div id="screen"></div>
  </main>

  <!-- Veil for player transition -->
  <div id="veil" class="fixed inset-0 bg-black/90 flex-col items-center justify-center z-50 hidden">
    <div class="bg-gray-800 border border-yellow-400/30 rounded-2xl p-8 max-w-md text-center shadow-2xl shadow-yellow-400/10">
      <h2 class="text-2xl font-bold text-yellow-300 mb-4">画面を隠してください</h2>
      <p class="text-gray-400 mb-6">次のプレイヤーの準備ができたら、下のボタンを押して端末を渡してください。</p>
      <button id="veilContinue" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-300 focus:ring-opacity-50">準備OK</button>
    </div>
  </div>

  <script>
    // ==============================
    // Game Elements
    // ==============================
    const titleEl = document.getElementById('title');
    const phaseLabel = document.getElementById('phaseLabel');
    const screen = document.getElementById('screen');
    const veil = document.getElementById('veil');
    const veilContinueBtn = document.getElementById('veilContinue');
    const $ = (sel) => document.querySelector(sel);

    let SCENARIO = null; // To be assigned after selection

    // SCENARIOS is loaded from scenarios.js file

    // ==============================
    // Game State
    // ==============================
    const state = {
      phase: 'pick',
      playerCount: 0,
      players: [], // {id, name, charKey}
      assignIdx: 0,
      voteIdx: 0,
      votes: [],
    };

    // ==============================
    // Utility Functions
    // ==============================
    function setPhaseLabel(text) {
      phaseLabel.textContent = text;
    }

    function handleImageError(img) {
      // 画像が読み込めない場合のプレースホルダー画像
      img.onerror = function() {
        this.src = 'https://placehold.co/600x400/4B5563/9CA3AF?text=No+Image';
      };
    }

    function openVeil(next) {
      veil.classList.remove('hidden');
      veil.classList.add('flex');
      veilContinueBtn.onclick = () => {
        veil.classList.add('hidden');
        veil.classList.remove('flex');
        next && next();
      };
    }

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    
    // ==============================
    // Render Functions
    // ==============================

    // Screen: Scenario Picker
    function renderScenarioPicker() {
      state.phase = 'pick';
      setPhaseLabel('シナリオ選択');
      titleEl.textContent = 'シナリオ未選択';
      
      // シナリオキーから画像パスを自動生成
      const getScenarioImage = (scenarioKey) => `public/images/${scenarioKey}/cover.jpg`;
      
      // カラーテーマの定義
      const colorThemes = {
        red: {
          border: 'border-red-800/50 hover:border-red-600',
          title: 'text-red-400',
          button: 'bg-red-800 hover:bg-red-700',
          placeholder: 'https://placehold.co/600x400/991B1B/FCA5A5?text=No+Image'
        },
        green: {
          border: 'border-green-800/50 hover:border-green-600',
          title: 'text-green-400',
          button: 'bg-green-800 hover:bg-green-700',
          placeholder: 'https://placehold.co/600x400/166534/86EFAC?text=No+Image'
        }
      };
      
      // シナリオカードを動的生成
      const scenarioCards = Object.entries(SCENARIOS).map(([key, scenario]) => {
        const theme = colorThemes[scenario.color] || colorThemes.red;
        return `
          <div class="bg-gray-900/70 rounded-xl ${theme.border} transition-all duration-300 flex flex-col overflow-hidden">
            <img src="${getScenarioImage(key)}" alt="${scenario.shortTitle}" class="w-full h-40 object-cover" onerror="this.src='${theme.placeholder}'">
            <div class="p-6 flex flex-col flex-grow">
              <h3 class="text-xl font-bold ${theme.title}">${scenario.shortTitle}</h3>
              <p class="text-gray-400 mt-2 mb-4 flex-grow">${scenario.description}</p>
              <button class="w-full mt-auto ${theme.button} text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105" id="pick-${key}">このシナリオを読み込む</button>
            </div>
          </div>
        `;
      }).join('');
      
      screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700">
          <h2 class="text-2xl font-bold text-yellow-300 mb-4">シナリオを選択</h2>
          <p class="text-gray-400 mb-6">プレイしたい歴史シナリオを選んでください。（3人プレイ専用です）</p>
          <div class="grid md:grid-cols-2 gap-6">
            ${scenarioCards}
          </div>
        </div>`;

      // 各シナリオボタンにイベントリスナーを設定
      Object.keys(SCENARIOS).forEach(key => {
        $(`#pick-${key}`).onclick = () => {
          SCENARIO = SCENARIOS[key];
          afterScenarioLoaded();
        };
      });
    }

    function afterScenarioLoaded() {
      titleEl.textContent = SCENARIO.title;
      renderSetup();
    }

    // Screen: Setup
    function renderSetup() {
      if (!SCENARIO) return renderScenarioPicker();
      state.phase = 'setup';
      setPhaseLabel('準備');
      const characterCount = SCENARIO.characters.length;

      screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700">
          <h2 class="text-2xl font-bold text-yellow-300 mb-2">ゲーム開始</h2>
          <p class="text-gray-400 mb-6">この簡易版は<b>1台の端末</b>を交代で操作して進行します。</p>
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Player Setup -->
            <div class="bg-gray-900/70 p-6 rounded-xl border border-gray-700">
              <h3 class="text-lg font-bold text-white">プレイ人数</h3>
              <p class="text-gray-300 mb-4">このシナリオは <b>${characterCount}人</b> でプレイします。</p>
              <div id="names"></div>
            </div>
            <!-- Scenario Overview -->
            <div class="bg-gray-900/70 p-6 rounded-xl border border-gray-700">
              <h3 class="text-lg font-bold text-white">シナリオ概要</h3>
              <p class="text-gray-400 text-sm mt-2">${SCENARIO.setting.era}／${SCENARIO.setting.place}</p>
              <p class="text-gray-300 mt-1">${SCENARIO.setting.status}</p>
              <ul class="list-disc list-inside text-gray-300 mt-4 space-y-1">
                <li><b>被害者：</b>${SCENARIO.victim.name}</li>
                <li><b>死因：</b>${SCENARIO.victim.cause}</li>
                <li><b>場所/日時：</b>${SCENARIO.victim.spot} / ${SCENARIO.victim.time}</li>
              </ul>
            </div>
          </div>
        </div>`;
      
      state.playerCount = characterCount;
      const namesBox = $('#names');
      namesBox.innerHTML = `
        <label class="text-sm text-gray-400 block mb-2">プレイヤー名（空欄可）</label>
        <div class="space-y-3 mb-4">
          ${Array.from({length: characterCount}).map((_, i) => `
            <input placeholder="プレイヤー${i + 1}" data-name-idx="${i}" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
          `).join('')}
        </div>
        <div class="flex flex-col sm:flex-row gap-3 mt-4">
          <button class="w-full bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-2 px-4 rounded-lg transition" id="startAssign">配役して開始</button>
          <button class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition" id="changeScenario">シナリオ変更</button>
        </div>`;

      $('#changeScenario').onclick = () => renderScenarioPicker();
      $('#startAssign').onclick = () => {
        const names = Array.from(screen.querySelectorAll('[data-name-idx]')).map((inp, i) => inp.value.trim() || `プレイヤー${i + 1}`);
        const chars = shuffle(SCENARIO.characters);
        state.players = names.map((name, i) => ({ id: i + 1, name, charKey: chars[i].key }));
        state.assignIdx = 0;
        state.votes = [];
        state.voteIdx = 0;
        openVeil(() => renderHandout());
      };
    }

    // Screen: Handout
    function renderHandout() {
      state.phase = 'handout';
      setPhaseLabel('ハンドアウト配布');
      const i = state.assignIdx;
      const player = state.players[i];
      const char = SCENARIO.characters.find(c => c.key === player.charKey);

      screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700 relative">
          <div class="absolute top-4 right-4 bg-yellow-500 text-gray-900 text-xs font-bold px-3 py-1 rounded-full">${i + 1} / ${state.playerCount}</div>
          <h2 class="text-2xl font-bold text-yellow-300 mb-4">${player.name} のハンドアウト</h2>
          <div class="grid md:grid-cols-5 gap-6">
            <!-- Character Info -->
            <div class="md:col-span-2 bg-gray-900/70 p-5 rounded-xl border border-yellow-400/30">
              <h3 class="text-xl font-bold text-yellow-300">あなたは【${char.name}】です</h3>
              <p class="text-gray-400 mt-1"><b>役割：</b>${char.role}</p>
              <p class="mt-4 text-gray-300"><b>あなたの秘密：</b><br>${char.secret}</p>
              <p class="mt-4 text-sm text-yellow-400/80 bg-yellow-900/30 p-3 rounded-md"><b>ヒント：</b>${char.hint}</p>
            </div>
            <!-- Case Info -->
            <div class="md:col-span-3 bg-gray-900/70 p-5 rounded-xl border border-red-800/50">
              <h3 class="text-xl font-bold text-red-400">事件概要（共通）</h3>
              <ul class="list-disc list-inside text-gray-300 mt-3 space-y-1">
                <li><b>被害者：</b>${SCENARIO.victim.name}</li>
                <li><b>死因：</b>${SCENARIO.victim.cause}</li>
                <li><b>場所/日時：</b>${SCENARIO.victim.spot}（${SCENARIO.victim.time}）</li>
              </ul>
              <h4 class="text-lg font-bold text-red-400 mt-5">初期証拠品</h4>
              <ul class="list-disc list-inside text-gray-300 mt-3 space-y-2">${SCENARIO.evidences.map(e => `<li><b>${e.title}</b>：${e.desc}</li>`).join('')}</ul>
            </div>
          </div>
          <div class="flex justify-end mt-6">
            ${i < state.playerCount - 1 ? '<button class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-lg transition" id="nextHandout">次の人へ</button>' : '<button class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg transition" id="toOverview">全体共有へ</button>'}
          </div>
        </div>`;

      const nextAction = (i < state.playerCount - 1) ? () => { state.assignIdx++; renderHandout(); } : renderOverview;
      const btnId = (i < state.playerCount - 1) ? '#nextHandout' : '#toOverview';
      $(btnId).onclick = () => openVeil(nextAction);
    }

    // Screen: Overview
    function renderOverview() {
      state.phase = 'overview';
      setPhaseLabel('情報共有');
      const assignedChars = state.players.map(p => SCENARIO.characters.find(c => c.key === p.charKey));
      screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700">
          <h2 class="text-2xl font-bold text-yellow-300 mb-4">全体共有</h2>
          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-gray-900/70 p-5 rounded-xl border border-gray-700">
              <h3 class="text-lg font-bold text-white">登場人物（今回の配役）</h3>
              <ul class="list-disc list-inside text-gray-300 mt-3 space-y-1">${assignedChars.map(c => `<li>${c.name}（${c.role}）</li>`).join('')}</ul>
            </div>
            <div class="bg-gray-900/70 p-5 rounded-xl border border-gray-700">
              <h3 class="text-lg font-bold text-white">証拠品</h3>
              <ul class="list-disc list-inside text-gray-300 mt-3 space-y-2">${SCENARIO.evidences.map(e => `<li><b>${e.title}</b>：${e.desc}</li>`).join('')}</ul>
            </div>
          </div>
          <div class="flex justify-between items-center mt-6">
            <span class="text-gray-400">口頭でアリバイや情報を共有してください。</span>
            <button class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg transition" id="toDebate">議論開始</button>
          </div>
        </div>`;
      $('#toDebate').onclick = renderDebate;
    }

    // Screen: Debate
    function renderDebate() {
        state.phase = 'debate';
        setPhaseLabel('議論');
        screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700">
            <h2 class="text-2xl font-bold text-yellow-300 mb-4">議論フェーズ</h2>
            <p class="text-gray-400 mb-6">口頭で自由に議論し、犯人を見つけ出してください。</p>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-gray-900/70 p-5 rounded-xl border border-gray-700">
                    <h3 class="text-lg font-bold text-white">配役</h3>
                    <ul class="list-disc list-inside text-gray-300 mt-3 space-y-1">${state.players.map(p => { const c = SCENARIO.characters.find(cc => cc.key === p.charKey); return `<li>${p.name}：<b>${c.name}</b></li>` }).join('')}</ul>
                </div>
                <div class="bg-gray-900/70 p-5 rounded-xl border border-gray-700">
                    <h3 class="text-lg font-bold text-white">証拠品早見</h3>
                    <ul class="list-disc list-inside text-gray-300 mt-3 space-y-2">${SCENARIO.evidences.map(e => `<li><b>${e.title}</b></li>`).join('')}</ul>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button class="bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition" id="toVote">投票へ</button>
            </div>
        </div>`;
        $('#toVote').onclick = () => {
            state.voteIdx = 0;
            state.votes = [];
            openVeil(renderVote);
        };
    }

    // Screen: Vote
    function renderVote() {
      state.phase = 'vote';
      setPhaseLabel('投票');
      const i = state.voteIdx;
      const voter = state.players[i];
      
      screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700 relative">
          <div class="absolute top-4 right-4 bg-yellow-500 text-gray-900 text-xs font-bold px-3 py-1 rounded-full">${i + 1} / ${state.playerCount}</div>
          <h2 class="text-2xl font-bold text-yellow-300 mb-4">${voter.name} の投票</h2>
          <p class="text-gray-400 mb-6">犯人だと思う人物を選んでください。（自分以外）</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="voteGrid">
            ${state.players.map(p => {
              const c = SCENARIO.characters.find(ac => ac.key === p.charKey);
              const isDisabled = p.id === voter.id;
              return `
                <button class="text-left p-4 rounded-lg border-2 transition-all duration-200 ${isDisabled ? 'bg-gray-700/50 border-gray-600 opacity-50 cursor-not-allowed' : 'bg-gray-900/70 border-gray-700 hover:border-yellow-400 hover:bg-gray-800'}" data-target="${c.key}" ${isDisabled ? 'disabled' : ''}>
                  <strong class="text-lg text-white">${c.name}</strong>
                  <small class="block text-gray-400">${p.name} の役</small>
                </button>`;
            }).join('')}
          </div>
          <div class="flex justify-end mt-6">
            <button class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg cursor-not-allowed" id="confirmVote" disabled>投票する</button>
          </div>
        </div>`;

      let selectedTarget = null;
      const confirmBtn = $('#confirmVote');
      screen.querySelectorAll('#voteGrid button').forEach(btn => {
        if (btn.disabled) return;
        btn.addEventListener('click', () => {
          screen.querySelectorAll('#voteGrid button').forEach(b => b.classList.remove('border-yellow-400', 'ring-2', 'ring-yellow-400'));
          btn.classList.add('border-yellow-400', 'ring-2', 'ring-yellow-400');
          selectedTarget = btn.dataset.target;
          confirmBtn.disabled = false;
          confirmBtn.classList.remove('bg-gray-600', 'cursor-not-allowed');
          confirmBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-400', 'text-gray-900');
        });
      });

      confirmBtn.onclick = () => {
        if (!selectedTarget) return;
        state.votes.push({ voterId: voter.id, targetCharKey: selectedTarget });
        if (i < state.playerCount - 1) {
          state.voteIdx++;
          openVeil(renderVote);
        } else {
          renderResult();
        }
      };
    }

    // Screen: Result
    function renderResult() {
        state.phase = 'result';
        setPhaseLabel('結果');
        const countMap = {};
        const keyToDisp = {};
        state.players.forEach(p => {
            const c = SCENARIO.characters.find(x => x.key === p.charKey);
            keyToDisp[c.key] = { char: c, player: p };
        });

        for (const v of state.votes) {
            countMap[v.targetCharKey] = (countMap[v.targetCharKey] || 0) + 1;
        }

        const rows = Object.keys(keyToDisp).map(k => ({
            key: k,
            disp: keyToDisp[k],
            votes: countMap[k] || 0
        })).sort((a, b) => b.votes - a.votes);

        const topVotes = rows[0]?.votes || 0;
        const tops = rows.filter(r => r.votes === topVotes);
        const mostVotedKey = (tops.length === 1) ? tops[0].key : null;
        const culpritKey = SCENARIO.culpritCharacterKey;
        const citizensWin = (mostVotedKey && mostVotedKey === culpritKey);
        
        let winnerText;
        if (mostVotedKey) {
            winnerText = citizensWin 
                ? '<span class="text-green-400">【市民チームの勝利】</span>真犯人（黒幕）を特定しました。' 
                : '<span class="text-red-400">【犯人チームの勝利】</span>投票で逃げ切りました。';
        } else {
            winnerText = '<span class="text-red-400">【犯人チームの勝利】</span>同票により犯人不在となりました。';
        }

        screen.innerHTML = `
        <div class="bg-gray-800/50 rounded-2xl p-6 shadow-lg border border-gray-700">
            <h2 class="text-3xl font-bold text-yellow-300 mb-6 text-center">投票結果</h2>
            
            <!-- Vote Results -->
            <div class="space-y-3 mb-8">
                ${rows.map(r => `
                    <div class="bg-gray-900/70 p-3 rounded-lg flex items-center gap-4 ${r.key === mostVotedKey ? 'ring-2 ring-yellow-400' : ''}">
                        <div class="w-1/3">
                            <b class="text-white">${r.disp.char.name}</b>
                            <span class="text-xs text-gray-400 block">(${r.disp.player.name})</span>
                        </div>
                        <div class="w-2/3 flex items-center gap-4">
                            <div class="w-full bg-gray-700 rounded-full h-2.5">
                                <div class="bg-yellow-400 h-2.5 rounded-full" style="width: ${(r.votes / state.playerCount) * 100}%"></div>
                            </div>
                            <b class="text-lg text-white">${r.votes} 票</b>
                        </div>
                    </div>
                `).join('')}
            </div>

            <!-- Winner/Loser -->
            <div class="bg-gray-900/70 p-5 rounded-xl border border-gray-700 text-center mb-6">
                <h3 class="text-xl font-bold text-white mb-2">勝敗</h3>
                <p class="text-lg">${winnerText}</p>
            </div>

            <!-- Truth -->
            <div class="bg-gray-900/70 p-5 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-3">真相</h3>
                <p class="text-gray-300"><b>真犯人（黒幕）：</b> ${SCENARIO.characters.find(c => c.key === culpritKey).name}</p>
                <p class="mt-2 text-gray-300"><b>動機：</b> ${SCENARIO.truth.motive}</p>
                <p class="mt-2 text-gray-300"><b>犯行方法：</b> ${SCENARIO.truth.method}</p>
                <p class="mt-3 text-sm text-gray-400 bg-gray-800 p-3 rounded-md"><b>要約：</b> ${SCENARIO.truth.summary}</p>
            </div>

            <!-- Restart -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
                <button class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition" id="backToPick">シナリオ選択へ</button>
                <button class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-lg transition" id="restart">同じシナリオで遊ぶ</button>
            </div>
        </div>`;
        
        $('#restart').onclick = renderSetup;
        $('#backToPick').onclick = renderScenarioPicker;
    }


    // Initial boot
    renderScenarioPicker();
  </script>
</body>
</html>
