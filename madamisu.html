<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マーダーミステリー - クリムゾン・マンション事件</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 100%);
            color: #f0f0f0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(139, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin-bottom: 10px;
        }

        .game-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .timer {
            font-size: 1.5em;
            color: #ff6b6b;
            font-weight: bold;
        }

        .phase {
            font-size: 1.2em;
            color: #FFD700;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .players-panel, .info-panel {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #8B0000;
        }

        .center-panel {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #8B0000;
        }

        .player-card {
            background: rgba(139, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #FFD700;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .player-card:hover {
            background: rgba(139, 0, 0, 0.4);
            transform: translateY(-2px);
        }

        .player-card.selected {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.2);
        }

        .player-card.current-player {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
        }

        .player-name {
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .player-role {
            font-size: 0.9em;
            color: #ccc;
        }

        .chat-container {
            height: 300px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid #444;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .message-sender {
            font-weight: bold;
            color: #FFD700;
        }

        .message-content {
            margin-left: 10px;
        }

        .system-message {
            background: rgba(78, 205, 196, 0.2);
            border-left: 3px solid #4ecdc4;
        }

        .system-message .message-sender {
            color: #4ecdc4;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid #444;
        }

        .chat-input input::placeholder {
            color: #aaa;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #8B0000, #CD5C5C);
            color: #fff;
        }

        .btn:hover {
            background: linear-gradient(45deg, #CD5C5C, #8B0000);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #FFA500, #FFD700);
        }

        .character-info {
            background: rgba(139, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #FFD700;
        }

        .character-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
        }

        .character-details {
            font-size: 0.9em;
            line-height: 1.4;
        }

        .secret-info {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .secret-title {
            color: #ff6b6b;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .evidence-list {
            list-style: none;
        }

        .evidence-item {
            background: rgba(78, 205, 196, 0.2);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 3px solid #4ecdc4;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .evidence-item:hover {
            background: rgba(78, 205, 196, 0.3);
        }

        .voting-section {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #FFD700;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .vote-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .vote-button {
            padding: 15px;
            background: rgba(139, 0, 0, 0.3);
            border: 2px solid #8B0000;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .vote-button:hover {
            background: rgba(139, 0, 0, 0.5);
            transform: scale(1.05);
        }

        .vote-button.selected {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
            color: #FFD700;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a1a, #2d1810);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            border: 3px solid #FFD700;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        .modal h2 {
            color: #FFD700;
            margin-bottom: 20px;
            text-align: center;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #fff;
        }

        .setup-screen {
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .setup-screen h2 {
            color: #FFD700;
            margin-bottom: 20px;
        }

        .setup-screen input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.1em;
            border: 2px solid #444;
        }

        .setup-screen input::placeholder {
            color: #aaa;
        }

        .character-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .character-option {
            background: rgba(139, 0, 0, 0.2);
            border: 2px solid #8B0000;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .character-option:hover {
            background: rgba(139, 0, 0, 0.4);
            transform: translateY(-2px);
        }

        .character-option.selected {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.2);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .game-status {
                flex-direction: column;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .chat-container {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- セットアップ画面 -->
        <div id="setupScreen" class="setup-screen">
            <div class="header">
                <h1>🏚️ クリムゾン・マンション殺人事件 🔍</h1>
                <p>山奥の豪華別荘で起きた謎の殺人事件...</p>
            </div>
            
            <h2>プレイヤー名を入力してください</h2>
            <input type="text" id="playerNameInput" placeholder="あなたの名前" maxlength="20">
            
            <h2>キャラクターを選択してください</h2>
            <div class="character-selection" id="characterSelection">
                <!-- キャラクター選択肢が動的に生成される -->
            </div>
            
            <button class="btn btn-primary" onclick="startGame()">ゲーム開始</button>
        </div>

        <!-- メインゲーム画面 -->
        <div id="gameScreen" style="display: none;">
            <div class="header">
                <h1>🏚️ クリムゾン・マンション殺人事件 🔍</h1>
            </div>

            <div class="game-status">
                <div class="timer" id="timer">05:00</div>
                <div class="phase" id="currentPhase">準備フェーズ</div>
                <button class="btn" onclick="nextPhase()">次のフェーズ</button>
            </div>

            <div class="main-content">
                <!-- プレイヤー一覧 -->
                <div class="players-panel">
                    <h3>🎭 参加者</h3>
                    <div id="playersList"></div>
                </div>

                <!-- メインエリア -->
                <div class="center-panel">
                    <div class="chat-container" id="chatContainer">
                        <!-- チャットメッセージが表示される -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="メッセージを入力..." maxlength="200">
                        <button class="btn" onclick="sendMessage()">送信</button>
                    </div>
                </div>

                <!-- 情報パネル -->
                <div class="info-panel">
                    <h3>📋 あなたの情報</h3>
                    <div id="characterInfo"></div>
                    
                    <h3>🔍 証拠品</h3>
                    <ul id="evidenceList" class="evidence-list"></ul>
                </div>
            </div>

            <!-- 投票セクション -->
            <div id="votingSection" class="voting-section" style="display: none;">
                <h3>🗳️ 犯人投票</h3>
                <p>誰が犯人だと思いますか？</p>
                <div id="voteGrid" class="vote-grid"></div>
                <button class="btn btn-primary" onclick="submitVote()" style="margin-top: 15px;">投票する</button>
            </div>
        </div>

        <!-- 結果モーダル -->
        <div id="resultModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>🎊 ゲーム結果</h2>
                <div id="resultContent"></div>
                <button class="btn btn-primary" onclick="restartGame()" style="margin-top: 20px;">もう一度プレイ</button>
            </div>
        </div>
    </div>

    <script>
        // ゲーム状態
        let gameState = {
            currentPhase: 0,
            timeLeft: 300,
            players: [],
            currentPlayer: null,
            selectedCharacter: null,
            votes: {},
            messages: [],
            evidence: [],
            isVotingPhase: false
        };

        // フェーズ設定
        const phases = [
            { name: "準備フェーズ", duration: 300 },
            { name: "情報収集", duration: 600 },
            { name: "第1回議論", duration: 900 },
            { name: "密談タイム", duration: 300 },
            { name: "最終議論", duration: 900 },
            { name: "投票フェーズ", duration: 300 },
            { name: "結果発表", duration: 0 }
        ];

        // キャラクター設定
        const characters = [
            {
                id: 'son',
                name: '息子 - 大学生のタケシ',
                role: '被害者の息子',
                description: '父親の遺産相続に悩む大学生。最近父親と金銭トラブルがあった。',
                secret: '実は多額の借金があり、父親に泣きついていた。',
                alibi: '事件当時、自室で勉強していた。',
                isCriminal: false
            },
            {
                id: 'secretary',
                name: '秘書 - 美咲',
                role: '被害者の秘書',
                description: '10年間仕える有能な秘書。被害者の全ての秘密を知っている。',
                secret: '被害者の不正な取引を知っており、それを理由に昇給を要求していた。',
                alibi: '事件当時、書類整理をしていた。',
                isCriminal: true // 真犯人
            },
            {
                id: 'chef',
                name: '料理人 - 田中',
                role: '専属料理人',
                description: '家族の医療費のため働いているベテラン料理人。',
                secret: '実は料理に睡眠薬を混ぜたことがある（今回の事件とは無関係）。',
                alibi: '事件当時、キッチンで翌日の準備をしていた。',
                isCriminal: false
            },
            {
                id: 'maid',
                name: 'メイド - 花子',
                role: '新人メイド',
                description: '3ヶ月前から働き始めた新人。過去に問題を起こして前職を辞めた。',
                secret: '前職で窃盗の疑いをかけられて辞めた（実際は濡れ衣）。',
                alibi: '事件当時、2階の掃除をしていた。',
                isCriminal: false
            },
            {
                id: 'doctor',
                name: '医師 - 佐藤先生',
                role: '家族の友人',
                description: '被害者家族の古い友人で、定期的に健康診断をしている医師。',
                secret: '実は多額の借金があり、被害者にお金を借りていた。',
                alibi: '事件当時、庭で電話をしていた。',
                isCriminal: false
            },
            {
                id: 'lawyer',
                name: '弁護士 - 鈴木',
                role: '顧問弁護士',
                description: '被害者の遺言書作成に関わっている弁護士。',
                secret: '遺言書の内容を事前に息子に教えてしまった。',
                alibi: '事件当時、書斎で遺言書の最終確認をしていた。',
                isCriminal: false
            }
        ];

        // 証拠品
        const evidenceItems = [
            '毒入りブランデーグラス - 被害者が飲んでいたグラスから毒物検出',
            '破かれた遺言書 - 書斎で発見された遺言書の断片',
            '被害者の日記 - 最近の人間関係について記述',
            '不審な電話記録 - 事件前日の謎の電話',
            '空の薬瓶 - 書斎の隅で発見された薬品の容器',
            '別荘の見取り図 - 秘密の通路が記されている'
        ];

        let timer;

        // 初期化
        function initGame() {
            displayCharacterSelection();
        }

        // キャラクター選択表示
        function displayCharacterSelection() {
            const container = document.getElementById('characterSelection');
            container.innerHTML = '';
            
            characters.forEach(character => {
                const div = document.createElement('div');
                div.className = 'character-option';
                div.onclick = () => selectCharacter(character.id);
                div.innerHTML = `
                    <div class="character-name">${character.name}</div>
                    <div class="character-details">${character.description}</div>
                `;
                container.appendChild(div);
            });
        }

        // キャラクター選択
        function selectCharacter(characterId) {
            // 前の選択を解除
            document.querySelectorAll('.character-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            // 新しい選択を適用
            event.target.closest('.character-option').classList.add('selected');
            gameState.selectedCharacter = characterId;
        }

        // ゲーム開始
        function startGame() {
            const playerName = document.getElementById('playerNameInput').value.trim();
            if (!playerName) {
                alert('プレイヤー名を入力してください');
                return;
            }
            
            if (!gameState.selectedCharacter) {
                alert('キャラクターを選択してください');
                return;
            }

            // プレイヤー初期化
            gameState.currentPlayer = {
                name: playerName,
                characterId: gameState.selectedCharacter
            };

            // NPCプレイヤーを追加
            initializePlayers();
            
            // 画面切り替え
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            // ゲーム開始
            updateDisplay();
            startTimer();
            addSystemMessage('ゲーム開始！嵐により外部と遮断された別荘で殺人事件が発生しました...');
            addSystemMessage('被害者：富豪の父親（別荘の主人）');
            addSystemMessage('死因：毒殺');
            addSystemMessage('発見場所：書斎');
            addSystemMessage('発見時刻：夜10時頃');
        }

        // プレイヤー初期化
        function initializePlayers() {
            gameState.players = [];
            
            // 現在のプレイヤーを追加
            const playerCharacter = characters.find(c => c.id === gameState.selectedCharacter);
            gameState.players.push({
                name: gameState.currentPlayer.name,
                character: playerCharacter,
                isCurrentPlayer: true
            });

            // 他のキャラクターをNPCとして追加
            characters.forEach(character => {
                if (character.id !== gameState.selectedCharacter) {
                    gameState.players.push({
                        name: character.name.split(' - ')[1] || character.name,
                        character: character,
                        isCurrentPlayer: false
                    });
                }
            });

            // 証拠品初期化
            gameState.evidence = evidenceItems.slice(0, 3); // 最初は3つの証拠
        }

        // 表示更新
        function updateDisplay() {
            updatePlayersList();
            updateCharacterInfo();
            updateEvidenceList();
            updatePhaseDisplay();
        }

        // プレイヤーリスト更新
        function updatePlayersList() {
            const container = document.getElementById('playersList');
            container.innerHTML = '';
            
            gameState.players.forEach(player => {
                const div = document.createElement('div');
                div.className = `player-card ${player.isCurrentPlayer ? 'current-player' : ''}`;
                div.innerHTML = `
                    <div class="player-name">${player.name}</div>
                    <div class="player-role">${player.character.role}</div>
                `;
                container.appendChild(div);
            });
        }

        // キャラクター情報更新
        function updateCharacterInfo() {
            const container = document.getElementById('characterInfo');
            const currentPlayerData = gameState.players.find(p => p.isCurrentPlayer);
            
            if (currentPlayerData) {
                const character = currentPlayerData.character;
                container.innerHTML = `
                    <div class="character-info">
                        <div class="character-name">${character.name}</div>
                        <div class="character-details">
                            <p><strong>役職：</strong>${character.role}</p>
                            <p><strong>詳細：</strong>${character.description}</p>
                            <p><strong>アリバイ：</strong>${character.alibi}</p>
                        </div>
                        <div class="secret-info">
                            <div class="secret-title">🤫 あなたの秘密</div>
                            <div>${character.secret}</div>
                        </div>
                    </div>
                `;
            }
        }

        // 証拠品リスト更新
        function updateEvidenceList() {
            const container = document.getElementById('evidenceList');
            container.innerHTML = '';
            
            gameState.evidence.forEach((evidence, index) => {
                const li = document.createElement('li');
                li.className = 'evidence-item';
                li.textContent = evidence;
                li.onclick = () => shareEvidence(index);
                container.appendChild(li);
            });
        }

        // フェーズ表示更新
        function updatePhaseDisplay() {
            document.getElementById('currentPhase').textContent = phases[gameState.currentPhase].name;
            
            // 投票フェーズの表示制御
            if (gameState.currentPhase === 5) {
                showVotingSection();
            } else {
                document.getElementById('votingSection').style.display = 'none';
            }
        }

        // タイマー開始
        function startTimer() {
            gameState.timeLeft = phases[gameState.currentPhase].duration;
            updateTimer();
            
            timer = setInterval(() => {
                gameState.timeLeft--;
                updateTimer();
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(timer);
                    if (gameState.currentPhase < phases.length - 1) {
                        nextPhase();
                    }
                }
            }, 1000);
        }

        // タイマー更新
        function updateTimer() {
            const minutes = Math.floor(gameState.timeLeft / 60);
            const seconds = gameState.timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // 次のフェーズ
        function nextPhase() {
            clearInterval(timer);
            
            if (gameState.currentPhase < phases.length - 1) {
                gameState.currentPhase++;
                
                // フェーズ変更時の処理
                switch (gameState.currentPhase) {
                    case 1:
                        addSystemMessage('情報収集フェーズ開始！各自の情報を共有しましょう。');
                        addMoreEvidence();
                        break;
                    case 2:
                        addSystemMessage('第1回議論開始！疑わしい点について話し合いましょう。');
                        simulateNPCMessages();
                        break;
                    case 3:
                        addSystemMessage('密談タイム！個別に相談することができます。');
                        break;
                    case 4:
                        addSystemMessage('最終議論！これまでの情報を整理して犯人を特定しましょう。');
                        addMoreEvidence();
                        break;
                    case 5:
                        addSystemMessage('投票フェーズ！犯人だと思う人に投票してください。');
                        break;
                    case 6:
                        showResults();
                        return;
                }
                
                updateDisplay();
                if (phases[gameState.currentPhase].duration > 0) {
                    startTimer();
                }
            }
        }

        // 追加証拠品
        function addMoreEvidence() {
            if (gameState.evidence.length < evidenceItems.length) {
                const newEvidence = evidenceItems[gameState.evidence.length];
                gameState.evidence.push(newEvidence);
                updateEvidenceList();
                addSystemMessage(`新しい証拠が発見されました：${newEvidence}`);
            }
        }

        // NPCメッセージシミュレーション
        function simulateNPCMessages() {
            const npcMessages = [
                { sender: '田中（料理人）', message: '私は事件当時キッチンにいました。誰も見ていませんが...' },
                { sender: '花子（メイド）', message: '2階で掃除をしていて、何も見ていません。' },
                { sender: '佐藤先生', message: '庭で電話をしていました。重要な話だったので...' },
                { sender: '美咲（秘書）', message: '書類整理をしていました。いつも通りの作業です。' }
            ];
            
            let delay = 2000;
            npcMessages.forEach((msg, index) => {
                setTimeout(() => {
                    addMessage(msg.sender, msg.message);
                }, delay * (index + 1));
            });
        }

        // メッセージ送信
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage(gameState.currentPlayer.name, message);
                input.value = '';
                
                // NPCの簡単な反応をシミュレート
                setTimeout(() => {
                    simulateNPCResponse(message);
                }, 1000 + Math.random() * 2000);
            }
        }

        // エンターキーでメッセージ送信
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });

        // メッセージ追加
        function addMessage(sender, message) {
            gameState.messages.push({ sender, message, timestamp: Date.now() });
            
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = 'chat-message';
            div.innerHTML = `
                <span class="message-sender">${sender}:</span>
                <span class="message-content">${message}</span>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // システムメッセージ追加
        function addSystemMessage(message) {
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = 'chat-message system-message';
            div.innerHTML = `
                <span class="message-sender">🎭 システム:</span>
                <span class="message-content">${message}</span>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // NPCの反応をシミュレート
        function simulateNPCResponse(playerMessage) {
            const responses = [
                { name: '田中（料理人）', responses: ['そうですね...', '気になりますね', '私も同感です'] },
                { name: '花子（メイド）', responses: ['えっと...', 'そうなんですか？', '知りませんでした'] },
                { name: '佐藤先生', responses: ['なるほど', 'それは重要ですね', '確かに'] },
                { name: '美咲（秘書）', responses: ['そんなことは...', 'どうでしょうか', '私は違うと思います'] }
            ];
            
            const randomNPC = responses[Math.floor(Math.random() * responses.length)];
            const randomResponse = randomNPC.responses[Math.floor(Math.random() * randomNPC.responses.length)];
            
            addMessage(randomNPC.name, randomResponse);
        }

        // 証拠品共有
        function shareEvidence(index) {
            const evidence = gameState.evidence[index];
            addMessage(gameState.currentPlayer.name, `証拠品を提示：${evidence}`);
        }

        // 投票セクション表示
        function showVotingSection() {
            document.getElementById('votingSection').style.display = 'block';
            
            const voteGrid = document.getElementById('voteGrid');
            voteGrid.innerHTML = '';
            
            gameState.players.forEach(player => {
                if (!player.isCurrentPlayer) {
                    const button = document.createElement('div');
                    button.className = 'vote-button';
                    button.textContent = player.name;
                    button.onclick = () => selectVote(player.name);
                    voteGrid.appendChild(button);
                }
            });
        }

        // 投票選択
        function selectVote(playerName) {
            document.querySelectorAll('.vote-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            gameState.selectedVote = playerName;
        }

        // 投票提出
        function submitVote() {
            if (!gameState.selectedVote) {
                alert('投票する相手を選択してください');
                return;
            }
            
            gameState.votes[gameState.currentPlayer.name] = gameState.selectedVote;
            addSystemMessage(`${gameState.currentPlayer.name}が投票しました`);
            
            // NPCの投票をシミュレート
            simulateNPCVotes();
            
            setTimeout(() => {
                nextPhase();
            }, 2000);
        }

        // NPCの投票をシミュレート
        function simulateNPCVotes() {
            const npcs = gameState.players.filter(p => !p.isCurrentPlayer);
            const votableTargets = gameState.players.map(p => p.name);
            
            npcs.forEach(npc => {
                const possibleTargets = votableTargets.filter(name => name !== npc.name);
                const randomTarget = possibleTargets[Math.floor(Math.random() * possibleTargets.length)];
                gameState.votes[npc.name] = randomTarget;
            });
        }

        // 結果表示
        function showResults() {
            clearInterval(timer);
            
            // 投票結果の集計
            const voteCount = {};
            Object.values(gameState.votes).forEach(vote => {
                voteCount[vote] = (voteCount[vote] || 0) + 1;
            });
            
            // 最多得票者を決定
            let maxVotes = 0;
            let suspectedCriminal = '';
            Object.entries(voteCount).forEach(([name, votes]) => {
                if (votes > maxVotes) {
                    maxVotes = votes;
                    suspectedCriminal = name;
                }
            });
            
            // 真犯人を特定
            const actualCriminal = gameState.players.find(p => p.character.isCriminal);
            const isCorrect = suspectedCriminal === actualCriminal.name;
            
            // 結果表示
            let resultHTML = `
                <h3>🗳️ 投票結果</h3>
                <div style="margin: 20px 0;">
            `;
            
            Object.entries(voteCount).forEach(([name, votes]) => {
                resultHTML += `<p>${name}: ${votes}票</p>`;
            });
            
            resultHTML += `</div>
                <h3>🎭 真実の公開</h3>
                <div style="margin: 20px 0;">
                    <p><strong>真犯人：</strong>${actualCriminal.name}</p>
                    <p><strong>動機：</strong>${actualCriminal.character.secret}</p>
                    <p><strong>推理結果：</strong>${isCorrect ? '🎉 正解！' : '❌ 残念...'}</p>
                </div>
                
                <h3>📚 各キャラクターの真実</h3>
                <div style="margin: 20px 0;">
            `;
            
            gameState.players.forEach(player => {
                resultHTML += `
                    <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                        <strong>${player.name} (${player.character.role})</strong><br>
                        秘密: ${player.character.secret}
                    </div>
                `;
            });
            
            resultHTML += '</div>';
            
            document.getElementById('resultContent').innerHTML = resultHTML;
            document.getElementById('resultModal').style.display = 'flex';
        }

        // モーダルを閉じる
        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
        }

        // ゲームリスタート
        function restartGame() {
            // ゲーム状態をリセット
            gameState = {
                currentPhase: 0,
                timeLeft: 300,
                players: [],
                currentPlayer: null,
                selectedCharacter: null,
                votes: {},
                messages: [],
                evidence: [],
                isVotingPhase: false
            };
            
            // 画面をリセット
            document.getElementById('playerNameInput').value = '';
            document.getElementById('messageInput').value = '';
            document.getElementById('chatContainer').innerHTML = '';
            document.querySelectorAll('.character-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            // セットアップ画面に戻る
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('setupScreen').style.display = 'block';
            closeModal();
            
            // キャラクター選択を再表示
            displayCharacterSelection();
        }

        // 初期化実行
        document.addEventListener('DOMContentLoaded', function() {
            initGame();
        });
